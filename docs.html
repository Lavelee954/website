<!--
 Copyright 2023 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->



<html>
  
  <head>
    




<script async src="https://www.googletagmanager.com/gtag/js?id=G-GWZW7L8C6L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GWZW7L8C6L');
</script>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, minimum-scale=1">

    <title>Service Weaver Docs</title>
    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="stylesheet" href="/assets/css/docs.css">
  </head>
  <body>
    

<header>
  <div class="header-menu">
    <a href="/" class="logo">
      <span>Service Weaver</span>
    </a>
    <ul>
      <li><a href="/" class="navlink ">Home</a></li>
      <li><a href="/docs.html" class="navlink active">Docs</a></li>
      <li><a href="/blog" class="navlink ">Blog</a></li>
      <li><a href="/contact.html" class="navlink ">Contact Us</a></li>
      <li><a href="https://pkg.go.dev/github.com/ServiceWeaver/weaver" class="navlink">API</a></li>
    </ul>
  </div>
  <a class="icon" href="https://github.com/ServiceWeaver/weaver">
    <img src="/assets/images/github_logo.svg" alt="GitHub">
  </a>
</header>

    <div class="page">
      <div class="holder">
        <input type="checkbox" id="toc-toggle" checked/>
        <label id="toc-button" for="toc-toggle" title="Click to toggle table of contents">☰</label>
        <div class="toc" id="toc"></div>
        <div class="contents" id="contents">
          <div hidden class="todo">
TODO: Link to code snippets to make sure they are compilable and runnable.
</div>
<h1>What is Service Weaver?</h1>
<p>Service Weaver is a programming framework for writing, deploying, and managing
distributed applications. You can run, test, and debug a Service Weaver application
locally on your machine, and then deploy the application to the cloud with a
single command.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go run .                      <span style="color:#75715e"># Run locally.</span>
</span></span><span style="display:flex;"><span>$ weaver gke deploy weaver.toml <span style="color:#75715e"># Run in the cloud.</span>
</span></span></code></pre><p>A Service Weaver application is composed of a number <strong>components</strong>. A component is
represented as a regular Go <a href="https://go.dev/tour/methods/9">interface</a>, and components interact
with each other by calling the methods defined by these interfaces. This makes
writing Service Weaver applications easy. You don't have to write any networking or
serialization code; you just write Go. Service Weaver also provides libraries for
logging, metrics, tracing, routing, testing, and more.</p>
<p>You can deploy a Service Weaver application as easily as running a single command. Under
the covers, Service Weaver will dissect your binary along component boundaries, allowing
different components to run on different machines. Service Weaver will replicate,
autoscale, and co-locate these distributed components for you. It will also
manage all the networking details on your behalf, ensuring that different
components can communicate with each other and that clients can communicate with
your application.</p>
<p>Refer to the <a href="#installation">Installation</a> section to install Service Weaver on
your machine, or read the <a href="#step-by-step-tutorial">Step by Step Tutorial</a>
section for a tutorial on how to write Service Weaver applications.</p>
<h1>Installation</h1>
<p>Ensure you have <a href="https://go.dev/doc/install">Go installed</a>, version 1.19 or higher. Then, run
the following to install the <code>weaver</code> command:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go install github.com/ServiceWeaver/weaver/cmd/weaver@latest
</span></span></code></pre><p><code>go install</code> installs the <code>weaver</code> command to <code>$GOBIN</code>, which defaults to
<code>$GOPATH/bin</code>. Make sure this directory is included in your <code>PATH</code>. You can
accomplish this, for example, by adding the following to your <code>.bashrc</code> and
running <code>source ~/.bashrc</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ export PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$PATH<span style="color:#e6db74">:</span>$GOPATH<span style="color:#e6db74">/bin&#34;</span>
</span></span></code></pre><p>If the installation was successful, you should be able to run <code>weaver --help</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver --help
</span></span><span style="display:flex;"><span>USAGE
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  weaver generate                 // weaver code generator
</span></span><span style="display:flex;"><span>  weaver single    &lt;command&gt; ...  // for single process deployments
</span></span><span style="display:flex;"><span>  weaver multi     &lt;command&gt; ...  // for multiprocess deployments
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre><p><strong>Note</strong>: For GKE deployments you should also install the <code>weaver gke</code> command
(see the <a href="#gke">GKE</a> section for details):</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go install github.com/ServiceWeaver/weaver-gke/cmd/weaver-gke@latest
</span></span></code></pre><h1>Step by Step Tutorial</h1>
<p>In this section, we show you how to write Service Weaver applications. To follow
along, refer to the <a href="#installation">Installation</a> section to install Service
Weaver. The full source code presented in this tutorial can be found in <a href="https://github.com/ServiceWeaver/weaver/tree/main/examples/hello">the
examples directory on the project's GitHub page</a>.</p>
<h2>Listeners and Servers</h2>
<p>We begin with a simple &quot;Hello, World!&quot; HTTP server. Run <code>go mod init hello</code> to create a go module.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ mkdir hello/
</span></span><span style="display:flex;"><span>$ cd hello/
</span></span><span style="display:flex;"><span>$ go mod init hello
</span></span></code></pre><p>Create a file called <code>main.go</code> with the following contents:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#fff">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/ServiceWeaver/weaver&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#fff">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get a network listener on address &#34;localhost:12345&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">root</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weaver</span>.<span style="color:#fff">Init</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Background</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#fff">opts</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weaver</span>.<span style="color:#fff">ListenerOptions</span>{<span style="color:#fff">LocalAddress</span>: <span style="color:#e6db74">&#34;localhost:12345&#34;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#fff">lis</span>, <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">root</span>.<span style="color:#fff">Listener</span>(<span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#fff">opts</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#fff">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">log</span>.<span style="color:#fff">Fatal</span>(<span style="color:#fff">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff">fmt</span>.<span style="color:#fff">Printf</span>(<span style="color:#e6db74">&#34;hello listener available on %v\n&#34;</span>, <span style="color:#fff">lis</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Serve the /hello endpoint.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">http</span>.<span style="color:#fff">HandleFunc</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#fff">w</span> <span style="color:#fff">http</span>.<span style="color:#fff">ResponseWriter</span>, <span style="color:#fff">r</span> <span style="color:#f92672">*</span><span style="color:#fff">http</span>.<span style="color:#fff">Request</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">fmt</span>.<span style="color:#fff">Fprintf</span>(<span style="color:#fff">w</span>, <span style="color:#e6db74">&#34;Hello, %s!\n&#34;</span>, <span style="color:#fff">r</span>.<span style="color:#fff">URL</span>.<span style="color:#fff">Query</span>().<span style="color:#fff">Get</span>(<span style="color:#e6db74">&#34;name&#34;</span>))
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#fff">http</span>.<span style="color:#fff">Serve</span>(<span style="color:#fff">lis</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Here's an explanation of the code:</p>
<ul>
<li><code>weaver.Init(...)</code> initializes the Service Weaver application. It also returns
a <code>weaver.Instance</code>, which we assign to <code>root</code>. We'll explain instances in
more detail momentarily.</li>
<li><code>root.Listener(...)</code> returns a network listener, similar to
<a href="https://pkg.go.dev/net#Listen"><code>net.Listen</code></a>. With Service Weaver, listeners are named. In this
case, we name the listener <code>&quot;hello&quot;</code>. A <code>weaver.ListenerOptions</code> configures
the listener. Here, we specify that the listener should listen on address
<code>localhost:12345</code>.</li>
<li><code>http.HandleFunc(...)</code> registers an HTTP handler for the <code>/hello?name=&lt;name&gt;</code>
endpoint. The handler returns a <code>Hello, &lt;name&gt;!</code> greeting.</li>
<li><code>http.Serve(lis, nil)</code> runs the HTTP server on the provided listener.</li>
</ul>
<p>Run <code>go mod tidy</code> and then <code>go run .</code>. The program should print out the name of
the application and a unique deployment id. It should then block serving HTTP
requests on <code>localhost:12345</code>.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go mod tidy
</span></span><span style="display:flex;"><span>$ go run .
</span></span><span style="display:flex;"><span>╭───────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ app        : hello                                │
</span></span><span style="display:flex;"><span>│ deployment : 28807368-1101-41a3-bdcb-9625e0f02ca0 │
</span></span><span style="display:flex;"><span>╰───────────────────────────────────────────────────╯
</span></span><span style="display:flex;"><span>hello listener available on 127.0.0.1:12345
</span></span><span style="display:flex;"><span>...
</span></span></code></pre><p>In a separate terminal, curl the server to receive a greeting:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ curl localhost:12345/hello?name<span style="color:#f92672">=</span>Weaver
</span></span><span style="display:flex;"><span>Hello, Weaver!
</span></span></code></pre><h2>Components</h2>
<p>A Service Weaver application is composed of a number of <strong>components</strong>. A
Service Weaver component is represented with a regular Go
<a href="https://go.dev/tour/methods/9">interface</a>, and components interact with each other by calling
the methods defined by these interfaces.  In this section, we'll define a simple
<code>Reverser</code> component that can reverse strings. Create a file <code>reverser.go</code> with
the following contents:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#fff">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/ServiceWeaver/weaver&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Reverser component.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#fff">Reverser</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Reverse</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Implementation of the Reverser component.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#fff">reverser</span> <span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Reverser</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">r</span> <span style="color:#f92672">*</span><span style="color:#fff">reverser</span>) <span style="color:#fff">Reverse</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">s</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">runes</span> <span style="color:#f92672">:=</span> []rune(<span style="color:#fff">s</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff">n</span> <span style="color:#f92672">:=</span> len(<span style="color:#fff">runes</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#fff">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#fff">i</span> &lt; <span style="color:#fff">n</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>; <span style="color:#fff">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">runes</span>[<span style="color:#fff">i</span>], <span style="color:#fff">runes</span>[<span style="color:#fff">n</span><span style="color:#f92672">-</span><span style="color:#fff">i</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] = <span style="color:#fff">runes</span>[<span style="color:#fff">n</span><span style="color:#f92672">-</span><span style="color:#fff">i</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#fff">runes</span>[<span style="color:#fff">i</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> string(<span style="color:#fff">runes</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The <code>Reverser</code> component is represented as a <code>Reverser</code> interface with,
unsurprisingly, a <code>Reverse</code> method that reverses strings. The <code>reverser</code> struct
is our implementation of the <code>Reverser</code> component (as indicated by the
<code>weaver.Implements[Reverser]</code> field it contains). Next, edit the server in
<code>main.go</code> to use the <code>Reverser</code> component:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#fff">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get a network listener on address &#34;localhost:12345&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff">fmt</span>.<span style="color:#fff">Printf</span>(<span style="color:#e6db74">&#34;hello listener available on %v\n&#34;</span>, <span style="color:#fff">lis</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get a client to the Reverser component.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">reverser</span>, <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weaver</span>.<span style="color:#fff">Get</span>[<span style="color:#fff">Reverser</span>](<span style="color:#fff">root</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#fff">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">log</span>.<span style="color:#fff">Fatal</span>(<span style="color:#fff">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Serve the /hello endpoint.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">http</span>.<span style="color:#fff">HandleFunc</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#fff">w</span> <span style="color:#fff">http</span>.<span style="color:#fff">ResponseWriter</span>, <span style="color:#fff">r</span> <span style="color:#f92672">*</span><span style="color:#fff">http</span>.<span style="color:#fff">Request</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">reversed</span>, <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">reverser</span>.<span style="color:#fff">Reverse</span>(<span style="color:#fff">r</span>.<span style="color:#fff">Context</span>(), <span style="color:#fff">r</span>.<span style="color:#fff">URL</span>.<span style="color:#fff">Query</span>().<span style="color:#fff">Get</span>(<span style="color:#e6db74">&#34;name&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#fff">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff">http</span>.<span style="color:#fff">Error</span>(<span style="color:#fff">w</span>, <span style="color:#fff">err</span>.<span style="color:#fff">Error</span>(), <span style="color:#fff">http</span>.<span style="color:#fff">StatusInternalServerError</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff">fmt</span>.<span style="color:#fff">Fprintf</span>(<span style="color:#fff">w</span>, <span style="color:#e6db74">&#34;Hello, %s!\n&#34;</span>, <span style="color:#fff">reversed</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#fff">http</span>.<span style="color:#fff">Serve</span>(<span style="color:#fff">lis</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><code>weaver.Get[Reverser](root)</code> returns an instance of the <code>Reverser</code> component. We
invoke methods on the component like we would any regular interface. In this
example, we call <code>reverser.Reverse</code>.</p>
<p>Before we build and run the server, we need to run Service Weaver's code
generator, called <code>weaver generate</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver generate .
</span></span></code></pre><p><code>weaver generate</code> should create a <code>weaver_gen.go</code> file. This file contains code
needed by the Service Weaver runtime. We'll elaborate on what exactly <code>weaver generate</code> does and why we need to run it later. Finally, re-run the server.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go run .
</span></span><span style="display:flex;"><span>╭───────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ app        : hello                                │
</span></span><span style="display:flex;"><span>│ deployment : 5c9753e4-c476-4f93-97a0-0ea599184178 │
</span></span><span style="display:flex;"><span>╰───────────────────────────────────────────────────╯
</span></span><span style="display:flex;"><span>hello listener available on 127.0.0.1:12345
</span></span><span style="display:flex;"><span>...
</span></span></code></pre><p>In a separate terminal, curl the server to receive a reversed greeting:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ curl localhost:12345/hello?name<span style="color:#f92672">=</span>Weaver
</span></span><span style="display:flex;"><span>Hello, revaeW!
</span></span></code></pre><p>Run <code>weaver single status</code> to view the status of the Service Weaver application.
The status shows every deployment, component, and listener.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver single status
</span></span><span style="display:flex;"><span>╭────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ DEPLOYMENTS                                        │
</span></span><span style="display:flex;"><span>├───────┬──────────────────────────────────────┬─────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT                           │ AGE │
</span></span><span style="display:flex;"><span>├───────┼──────────────────────────────────────┼─────┤
</span></span><span style="display:flex;"><span>│ hello │ 5c9753e4-c476-4f93-97a0-0ea599184178 │ 1s  │
</span></span><span style="display:flex;"><span>╰───────┴──────────────────────────────────────┴─────╯
</span></span><span style="display:flex;"><span>╭────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ COMPONENTS                                         │
</span></span><span style="display:flex;"><span>├───────┬────────────┬────────────────┬──────────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT │ COMPONENT      │ REPLICA PIDS │
</span></span><span style="display:flex;"><span>├───────┼────────────┼────────────────┼──────────────┤
</span></span><span style="display:flex;"><span>│ hello │ 5c9753e4   │ main           │ 691625       │
</span></span><span style="display:flex;"><span>│ hello │ 5c9753e4   │ hello.Reverser │ 691625       │
</span></span><span style="display:flex;"><span>╰───────┴────────────┴────────────────┴──────────────╯
</span></span><span style="display:flex;"><span>╭─────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ LISTENERS                                       │
</span></span><span style="display:flex;"><span>├───────┬────────────┬──────────┬─────────────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT │ LISTENER │ ADDRESS         │
</span></span><span style="display:flex;"><span>├───────┼────────────┼──────────┼─────────────────┤
</span></span><span style="display:flex;"><span>│ hello │ 5c9753e4   │ hello    │ 127.0.0.1:12345 │
</span></span><span style="display:flex;"><span>╰───────┴────────────┴──────────┴─────────────────╯
</span></span></code></pre><p>You can also run <code>weaver single dashboard</code> to open a dashboard in a web browser.</p>
<p>Components are the core abstraction of Service Weaver. All code in a Service
Weaver application runs as part of some component. Even the code inside of the
<code>main</code> function runs as part of an implicitly created <code>main</code> component (as shown
in the output of <code>weaver single status</code>).</p>
<p>The main advantage of components is that they decouple how you <em>write</em> your code
from how you <em>run</em> your code. They let you write your application as a monolith,
but when you go to run your code, you can run components in a separate process
or on a different machine entirely. Here's a diagram illustrating this concept:</p>
<p><img src="assets/images/components.svg" alt="A diagram showing off various types of Service Weaver deployments"></p>
<p>When we <code>go run</code> a Service Weaver application, all components run together in a single
process, and method calls between components are executed as regular Go method
calls. We'll now describe how to run each component in a separate process with
method calls between components executed as RPCs.</p>
<h2>Multiprocess Execution</h2>
<p>First, create a <a href="https://toml.io">TOML</a> file named <code>weaver.toml</code> with the
following contents:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[<span style="color:#fff">serviceweaver</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">binary</span> = <span style="color:#e6db74">&#34;./hello&#34;</span>
</span></span></code></pre><p>This config file specifies the binary of the Service Weaver application. Next,
build and run the app using <code>weaver multi deploy</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go build                        <span style="color:#75715e"># build the ./hello binary</span>
</span></span><span style="display:flex;"><span>$ weaver multi deploy weaver.toml <span style="color:#75715e"># deploy the application</span>
</span></span><span style="display:flex;"><span>╭───────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ app        : hello                                │
</span></span><span style="display:flex;"><span>│ deployment : 6b285407-423a-46cc-9a18-727b5891fc57 │
</span></span><span style="display:flex;"><span>╰───────────────────────────────────────────────────╯
</span></span><span style="display:flex;"><span>S1205 10:21:15.450917 stdout  26b601c4] hello listener available on 127.0.0.1:12345
</span></span><span style="display:flex;"><span>S1205 10:21:15.454387 stdout  88639bf8] hello listener available on 127.0.0.1:12345
</span></span></code></pre><p><strong>Note</strong>: <code>weaver multi</code> replicates every component twice, which is why you see
two log entries. We elaborate on replication more in the
<a href="#components">Components</a> section later.</p>
<p>In a separate terminal, curl the server:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ curl localhost:12345/hello?name<span style="color:#f92672">=</span>Weaver
</span></span><span style="display:flex;"><span>Hello, revaeW!
</span></span></code></pre><p>When the main component receives your <code>/hello</code> HTTP request, it calls the
<code>reverser.Reverse</code> method. This method call is executed as an RPC to the
<code>Reverser</code> component running in a different process. Remember earlier when we
ran <code>weaver generate</code>, the Service Weaver code generator? One thing that <code>weaver generate</code> does is generate RPC clients and servers for every component to make
this communication possible.</p>
<p>Run <code>weaver multi status</code> to view the status of the Service Weaver application.
Note that the <code>main</code> and <code>Reverser</code> components are replicated twice, and every
replica is run in its own OS process.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver multi status
</span></span><span style="display:flex;"><span>╭────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ DEPLOYMENTS                                        │
</span></span><span style="display:flex;"><span>├───────┬──────────────────────────────────────┬─────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT                           │ AGE │
</span></span><span style="display:flex;"><span>├───────┼──────────────────────────────────────┼─────┤
</span></span><span style="display:flex;"><span>│ hello │ 6b285407-423a-46cc-9a18-727b5891fc57 │ 3s  │
</span></span><span style="display:flex;"><span>╰───────┴──────────────────────────────────────┴─────╯
</span></span><span style="display:flex;"><span>╭──────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ COMPONENTS                                           │
</span></span><span style="display:flex;"><span>├───────┬────────────┬────────────────┬────────────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT │ COMPONENT      │ REPLICA PIDS   │
</span></span><span style="display:flex;"><span>├───────┼────────────┼────────────────┼────────────────┤
</span></span><span style="display:flex;"><span>│ hello │ 6b285407   │ main           │ 695110, 695115 │
</span></span><span style="display:flex;"><span>│ hello │ 6b285407   │ hello.Reverser │ 695136, 695137 │
</span></span><span style="display:flex;"><span>╰───────┴────────────┴────────────────┴────────────────╯
</span></span><span style="display:flex;"><span>╭─────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ LISTENERS                                       │
</span></span><span style="display:flex;"><span>├───────┬────────────┬──────────┬─────────────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT │ LISTENER │ ADDRESS         │
</span></span><span style="display:flex;"><span>├───────┼────────────┼──────────┼─────────────────┤
</span></span><span style="display:flex;"><span>│ hello │ 6b285407   │ hello    │ 127.0.0.1:12345 │
</span></span><span style="display:flex;"><span>╰───────┴────────────┴──────────┴─────────────────╯
</span></span></code></pre><p>You can also run <code>weaver multi dashboard</code> to open a dashboard in a web browser.</p>
<h2>Deploying to the Cloud</h2>
<p>The ability to run Service Weaver applications locally — either in a
single process with <code>go run</code> or across multiple processes with <code>weaver multi deploy</code> — makes it easy to quickly develop, debug, and test your
applications. When your application is ready for production, however, you'll
often want to deploy it to the cloud. Service Weaver makes this easy too.</p>
<p>For example, we can deploy our &quot;Hello, World&quot; application to <a href="https://cloud.google.com/kubernetes-engine">Google Kubernetes
Engine</a>, Google Cloud's hosted Kubernetes offering, as easily as running a
single command (see the <a href="#gke">GKE</a> section for details):</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver gke deploy weaver.toml
</span></span></code></pre><p>When you run this command, Service Weaver will</p>
<ul>
<li>wrap your application binary into a container;</li>
<li>upload the container to the cloud project of your choosing;</li>
<li>create and provision the appropriate Kubernetes clusters;</li>
<li>set up all load balancers and networking infrastructure;</li>
<li>deploy your application on Kubernetes, with components distributed across
machines in multiple regions.</li>
</ul>
<p>Service Weaver also integrates your application with existing cloud tooling.
Logs are uploaded to <a href="https://cloud.google.com/logging">Google Cloud Logging</a>, metrics are uploaded
to <a href="https://cloud.google.com/monitoring/api/metrics_gcp">Google Cloud Monitoring</a>, traces are uploaded to <a href="https://cloud.google.com/trace">Google
Cloud Tracing</a>, etc.</p>
<h2>Next Steps</h2>
<ul>
<li>Continue reading to get a better understanding of <a href="#components">components</a>
and learn about other fundamental features of Service Weaver like
<a href="#logging">logging</a>, <a href="#metrics">metrics</a>, <a href="#routing">routing</a>, and so on.</li>
<li>Dive deeper into the various ways you can deploy a Service Weaver application,
including <a href="#single-process">single process</a>, <a href="#multiprocess">multiprocess</a>,
and <a href="#gke">GKE</a> deployers.</li>
<li>Read through <a href="https://github.com/ServiceWeaver/weaver/tree/main/examples">example Service Weaver applications</a> that
demonstrate what Service Weaver has to offer.</li>
<li>Check out <a href="https://github.com/ServiceWeaver/weaver">Service Weaver's source code on GitHub</a>.</li>
<li>Read <a href="/blog">our blog</a>.</li>
</ul>
<div hidden class="todo">
    TODO(mwhittaker): Link to API docs.
    TODO(mwhittaker): Link to slack.
</div>
<h1>Components</h1>
<p><strong>Components</strong> are Service Weaver's core abstraction. A component is a
long-lived, possibly replicated entity that exposes a set of methods.
Concretely, a component is represented as a Go interface and corresponding
implementation of that interface. Consider the following <code>Adder</code> component for
example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">Adder</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Add</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">adder</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Adder</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#fff">adder</span>) <span style="color:#fff">Add</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">x</span>, <span style="color:#fff">y</span> <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#fff">x</span> <span style="color:#f92672">+</span> <span style="color:#fff">y</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><code>Adder</code> defines the component's interface, and <code>adder</code> defines the component's
implementation. The two are linked with the embedded <code>weaver.Implements[Adder]</code>
field. You can call the <code>weaver.Get[Adder]</code> function to get a client to the
<code>Adder</code> component. The returned client implements the component's interface, so
you can invoke the component's methods as you would any regular Go method. When
you invoke a component's method, the method call is performed by one of the
possibly many component replicas.</p>
<p>Components are generally long-lived, but the Service Weaver runtime may scale up
or scale down the number of replicas of a component over time based on load.
Similarly, component replicas may fail and get restarted. Service Weaver may
also move component replicas around, co-locating two chatty components in the
same OS process, for example, so that communication between the components is
done locally rather than over the network.</p>
<h2>Interfaces</h2>
<p>Every method in a component interface must receive a <code>context.Context</code> as its
first argument and return an <code>error</code> as its final result. All other arguments
must be <a href="#serializable-types">serializable</a>. These are all valid component
methods:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#fff">a</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span><span style="color:#fff">b</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span><span style="color:#fff">c</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff">d</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>)
</span></span></code></pre><p>These are all <em>invalid</em> component methods:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#fff">a</span>() <span style="color:#66d9ef">error</span>                          <span style="color:#75715e">// no context.Context argument
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#fff">b</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>)                 <span style="color:#75715e">// no error result
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#fff">c</span>(<span style="color:#66d9ef">int</span>, <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>) <span style="color:#66d9ef">error</span>      <span style="color:#75715e">// first argument isn&#39;t context.Context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#fff">d</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>) (<span style="color:#66d9ef">error</span>, <span style="color:#66d9ef">int</span>)    <span style="color:#75715e">// final result isn&#39;t error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#fff">e</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span> <span style="color:#75715e">// chan int isn&#39;t serializable
</span></span></span></code></pre><h2>Implementation</h2>
<p>A component implementation must be a struct that looks like:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">foo</span> <span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Foo</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre><ul>
<li>It must be a struct.</li>
<li>It must embed a <code>weaver.Implements[T]</code> field where <code>T</code> is the component
interface it implements.</li>
</ul>
<p><code>weaver.Implements[T]</code> implements the <code>weaver.Instance</code> interface and therefore
every component implementation (including <code>foo</code>) also implements
<code>weaver.Instance</code>.</p>
<p>If a component implementation implements an <code>Init(context.Context) error</code>
method, it will be called when an instance of the component is created.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">f</span> <span style="color:#f92672">*</span><span style="color:#fff">foo</span>) <span style="color:#fff">Init</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre><h2>Semantics</h2>
<p>When implementing a component, there are three semantic details to keep in mind:</p>
<ol>
<li>A component's state is not persisted.</li>
<li>A component's methods may be invoked concurrently.</li>
<li>There may be multiple replicas of a component.</li>
</ol>
<p>Take the following <code>Cache</code> component for example, which maintains an in-memory
key-value cache.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">Cache</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Put</span>(<span style="color:#fff">ctx</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">key</span>, <span style="color:#fff">value</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Get</span>(<span style="color:#fff">ctx</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">key</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">cache</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">mu</span> <span style="color:#fff">sync</span>.<span style="color:#fff">Mutex</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff">data</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">c</span> <span style="color:#f92672">*</span><span style="color:#fff">Cache</span>) <span style="color:#fff">Put</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">key</span>, <span style="color:#fff">value</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">c</span>.<span style="color:#fff">mu</span>.<span style="color:#fff">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#fff">c</span>.<span style="color:#fff">mu</span>.<span style="color:#fff">Unlock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fff">c</span>.<span style="color:#fff">data</span>[<span style="color:#fff">key</span>] = <span style="color:#fff">value</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">c</span> <span style="color:#f92672">*</span><span style="color:#fff">Cache</span>) <span style="color:#fff">Get</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">key</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">c</span>.<span style="color:#fff">mu</span>.<span style="color:#fff">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#fff">c</span>.<span style="color:#fff">mu</span>.<span style="color:#fff">Unlock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#fff">c</span>.<span style="color:#fff">data</span>[<span style="color:#fff">key</span>], <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Noting the points above:</p>
<ol>
<li>A <code>Cache</code>'s state is not persisted, so if a <code>Cache</code> replica fails, its data
is lost. Any state that needs to be persisted should be persisted
explicitly.</li>
<li>A <code>Cache</code>'s methods may be invoked concurrently, so it's essential that we
guard access to <code>data</code> with the mutex <code>mu</code>.</li>
<li>There may be multiple replicas of a <code>Cache</code> component, so it is not
guaranteed that one client's <code>Get</code> will be routed to the same replica as
another client's <code>Put</code>. For this example, this means that the <code>Cache</code> has
<a href="https://mwhittaker.github.io/consistency_in_distributed_systems/1_baseball.html">weak consistency</a>.</li>
</ol>
<p>Method calls are executed with at-most-once semantics. This means that Service Weaver
does not automatically retry method calls that fail. However, you can detect and
retry failed method calls explicitly using <code>weaver.ErrRetriable</code>. If a method
call fails because of a transient system error (e.g., a component replica
crashed, the network is partitioned), it returns an error with an embedded
<code>weaver.ErrRetriable</code>. This allows you to retry failed method calls like this:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#75715e">// Retry the cache.Get method call up to five times.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#fff">val</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#fff">err</span> <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#fff">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#fff">i</span> &lt; <span style="color:#ae81ff">5</span>; <span style="color:#fff">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">val</span>, <span style="color:#fff">err</span> = <span style="color:#fff">cache</span>.<span style="color:#fff">Get</span>(<span style="color:#fff">ctx</span>, <span style="color:#e6db74">&#34;key&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#fff">errors</span>.<span style="color:#fff">Is</span>(<span style="color:#fff">err</span>, <span style="color:#fff">weaver</span>.<span style="color:#fff">ErrRetriable</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Retriable system error! Retry.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h2>Lifetime</h2>
<p>The <code>weaver.Get</code> function returns a client to a component; <code>weaver.Get[Foo]</code>
returns a client to the <code>Foo</code> component, for example. Components are constructed
the first time you call <code>weaver.Get</code>. Constructing a component can sometimes be
expensive. When deploying a Service Weaver application on the cloud, for example,
constructing a component may involve launching a container. For this reason, we
recommend you call <code>weaver.Get</code> proactively to incur this overhead at
initialization time rather than on the critical path of serving a client
request.</p>
<h2>Config</h2>
<p>Service Weaver uses <a href="#config-files">config files</a>, written in <a href="#toml">TOML</a>, to
configure how applications are run. A minimal config file, for example, simply
lists the application binary:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[<span style="color:#fff">serviceweaver</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">binary</span> = <span style="color:#e6db74">&#34;./hello&#34;</span>
</span></span></code></pre><p>A config file may additionally contain component-specific configuration
sections, which allow you to configure the components in your application. For
example, consider the following <code>Greeter</code> component.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">Greeter</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Greet</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">greeter</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Greeter</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">g</span> <span style="color:#f92672">*</span><span style="color:#fff">greeter</span>) <span style="color:#fff">Greet</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">name</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#fff">fmt</span>.<span style="color:#fff">Sprintf</span>(<span style="color:#e6db74">&#34;Hello, %s!&#34;</span>, <span style="color:#fff">name</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Rather than hard-coding the greeting <code>&quot;Hello&quot;</code>, we can provide a greeting in a
config file. First, we define a options struct.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">greeterOptions</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Greeting</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Next, we associate the options struct with the <code>greeter</code> implementation by
embedding the <code>weaver.WithConfig[T]</code> struct.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">greeter</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Greeter</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">WithConfig</span>[<span style="color:#fff">greeterOptions</span>]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Now, we can add a <code>Greeter</code> section to the config file. The section is keyed by
the full path-prefixed name of the component.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[<span style="color:#e6db74">&#34;example.com/mypkg/Greeter&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">Greeting</span> = <span style="color:#e6db74">&#34;Bonjour&#34;</span>
</span></span></code></pre><p>When the <code>Greeter</code> component is created, Service Weaver will automatically parse
the <code>Greeter</code> section of the config file into a <code>greeterOptions</code> struct. You can
access the populated struct via the <code>Config</code> method of the embedded <code>WithConfig</code>
struct. For example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">g</span> <span style="color:#f92672">*</span><span style="color:#fff">greeter</span>) <span style="color:#fff">Greet</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">name</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">greeting</span> <span style="color:#f92672">:=</span> <span style="color:#fff">g</span>.<span style="color:#fff">Config</span>().<span style="color:#fff">Greeting</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#fff">greeting</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">greeting</span> = <span style="color:#e6db74">&#34;Hello&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#fff">fmt</span>.<span style="color:#fff">Sprintf</span>(<span style="color:#e6db74">&#34;%s, %s!&#34;</span>, <span style="color:#fff">greeting</span>, <span style="color:#fff">name</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><div hidden class="todo">
    Move the next part to the Single Process section and forward link.
</div>
<p>If you run an application directly (i.e. using <code>go run</code>), you can pass the
config file using the <code>SERVICEWEAVER_CONFIG</code> environment variable:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ SERVICEWEAVER_CONFIG<span style="color:#f92672">=</span>weaver.toml go run .
</span></span></code></pre><h1>Logging</h1>
<div hidden class="todo">
TODO(mwhittaker): Pick a better name for node ids?
</div>
<p>Service Weaver provides a logging API, <code>weaver.Logger</code>. By using Service
Weaver's logging API, you can cat, tail, search, and filter logs from every one
of your Service Weaver applications (past or present). Service Weaver also
integrates the logs into the environment where your application is deployed. If
you <a href="#gke">deploy a Service Weaver application to Google Cloud</a>, for example,
logs are automatically exported to <a href="https://cloud.google.com/logging">Google Cloud Logging</a>.</p>
<p>Use the <code>Logger</code> method of a component implementation to get a logger scoped to
the component. For example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">Adder</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Add</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">adder</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Adder</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">a</span> <span style="color:#f92672">*</span><span style="color:#fff">adder</span>) <span style="color:#fff">Add</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">x</span>, <span style="color:#fff">y</span> <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// adder embeds weaver.Implements[Adder] which provides the Logger method.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">logger</span> <span style="color:#f92672">:=</span> <span style="color:#fff">a</span>.<span style="color:#fff">Logger</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fff">logger</span>.<span style="color:#fff">Debug</span>(<span style="color:#e6db74">&#34;A debug log.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff">logger</span>.<span style="color:#fff">Info</span>(<span style="color:#e6db74">&#34;An info log.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff">logger</span>.<span style="color:#fff">Error</span>(<span style="color:#e6db74">&#34;An error log.&#34;</span>, <span style="color:#fff">fmt</span>.<span style="color:#fff">Errorf</span>(<span style="color:#e6db74">&#34;an error&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#fff">x</span> <span style="color:#f92672">+</span> <span style="color:#fff">y</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Logs look like this:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>D1103 08:55:15.650138 main.Adder 73ddcd04 adder.go:12] A debug log.
</span></span><span style="display:flex;"><span>I1103 08:55:15.650149 main.Adder 73ddcd04 adder.go:13] An info log.
</span></span><span style="display:flex;"><span>E1103 08:55:15.650158 main.Adder 73ddcd04 adder.go:14] An error log. err=&#34;an error&#34;
</span></span></code></pre><p>The first character of a log line indicates whether the log is a [D]ebug,
[I]nfo, or [E]rror log entry. Then comes the date in <code>MMDD</code> format, followed by
the time. Then comes the component name followed by a logical node id. If two
components are co-located in the same OS process, they are given the same node
id. Then comes the file and line where the log was produced, followed finally by
the contents of the log.</p>
<p>The main component returned by <code>weaver.Init</code> has a Logger method as well (like
all <code>weaver.Instances</code>):</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#fff">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">root</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weaver</span>.<span style="color:#fff">Init</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Background</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#fff">root</span>.<span style="color:#fff">Logger</span>().<span style="color:#fff">Info</span>(<span style="color:#e6db74">&#34;Hello, World!&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Service Weaver also allows you to attach key-value attributes to log entries.
These attributes can be useful when searching and filtering logs.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#fff">logger</span>.<span style="color:#fff">Info</span>(<span style="color:#e6db74">&#34;A log with attributes.&#34;</span>, <span style="color:#e6db74">&#34;foo&#34;</span>, <span style="color:#e6db74">&#34;bar&#34;</span>)  <span style="color:#75715e">// adds foo=&#34;bar&#34;
</span></span></span></code></pre><p>If you find yourself adding the same set of key-value attributes repeatedly, you
can pre-create a logger that will add those attributes to all log entries:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#fff">fooLogger</span> = <span style="color:#fff">logger</span>.<span style="color:#fff">With</span>(<span style="color:#e6db74">&#34;foo&#34;</span>, <span style="color:#e6db74">&#34;bar&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff">fooLogger</span>.<span style="color:#fff">Info</span>(<span style="color:#e6db74">&#34;A log with attributes.&#34;</span>)  <span style="color:#75715e">// adds foo=&#34;bar&#34;
</span></span></span></code></pre><p><strong>Note</strong>: You can also add normal print statements to your code. These prints
will be captured and logged by Service Weaver, but they won't be associated with
a particular component, they won't have <code>file:line</code> information, and they won't
have any attributes, so we recommend you use a <code>weaver.Logger</code> whenever
possible.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>S1027 14:40:55.210541 stdout d772dcad] This was printed by fmt.Println
</span></span></code></pre><p>Refer to the deployer-specific documentation to learn how to search and filter
logs for <a href="#single-process-logging">single process</a>,
<a href="#multiprocess-logging">multiprocess</a>, and <a href="#gke-logging">GKE</a> deployments.</p>
<h1>Metrics</h1>
<p>Service Weaver provides an API for <a href="https://prometheus.io/docs/concepts/metric_types/">metrics</a>; specifically
<a href="https://prometheus.io/docs/concepts/metric_types/#counter">counters</a>, <a href="https://prometheus.io/docs/concepts/metric_types/#gauge">gauges</a>, and
<a href="https://prometheus.io/docs/concepts/metric_types/#histogram">histograms</a>.</p>
<ul>
<li>A <strong>counter</strong> is a number that can only increase over time. It never
decreases. You can use a counter to measure things like the number of HTTP
requests your program has processed so far.</li>
<li>A <strong>gauge</strong> is a number that can increase <em>or</em> decrease over time. You can use
a gauge to measure things like the current amount of memory your program is
using, in bytes.</li>
<li>A <strong>histogram</strong> is a collection of numbers that are grouped into buckets. You
can use a histogram to measure things like the latency of every HTTP request
your program has received so far.</li>
</ul>
<p>Service Weaver integrates these metrics into the environment where your application is
deployed. If you <a href="#gke">deploy a Service Weaver application to Google Cloud</a>, for
example, metrics are automatically exported to the <a href="https://cloud.google.com/monitoring/charts/metrics-explorer">Google Cloud Metrics
Explorer</a> where they can be queried, aggregated, and graphed.</p>
<p>Here's an example of how to add metrics to a simple <code>Adder</code> component.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#fff">addCount</span> = <span style="color:#fff">weaver</span>.<span style="color:#fff">NewCounter</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;add_count&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;The number of times Adder.Add has been called&#34;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#fff">addConcurrent</span> = <span style="color:#fff">weaver</span>.<span style="color:#fff">NewGauge</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;add_concurrent&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;The number of concurrent Adder.Add calls&#34;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#fff">addSum</span> = <span style="color:#fff">weaver</span>.<span style="color:#fff">NewHistogram</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;add_sum&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;The sums returned by Adder.Add&#34;</span>,
</span></span><span style="display:flex;"><span>        []<span style="color:#66d9ef">float64</span>{<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">10000</span>},
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">Adder</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Add</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">adder</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Adder</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#fff">adder</span>) <span style="color:#fff">Add</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">x</span>, <span style="color:#fff">y</span> <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">addCount</span>.<span style="color:#fff">Add</span>(<span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff">addConcurrent</span>.<span style="color:#fff">Add</span>(<span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#fff">addConcurrent</span>.<span style="color:#fff">Sub</span>(<span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff">addSum</span>.<span style="color:#fff">Put</span>(float64(<span style="color:#fff">x</span> <span style="color:#f92672">+</span> <span style="color:#fff">y</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#fff">x</span> <span style="color:#f92672">+</span> <span style="color:#fff">y</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Refer to the deployer-specific documentation to learn how to view metrics for
<a href="#single-process-metrics">single process</a>, <a href="#multiprocess-metrics">multiprocess</a>,
and <a href="#gke-metrics">GKE</a> deployments.</p>
<h2>Labels</h2>
<p>Metrics can also have a set of key-value labels. Service Weaver represents
labels using structs. Here's an example of how to declare and use a labeled
counter to count the parity of the argument to a <code>Halve</code> method.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">halveLabels</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Parity</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">// &#34;odd&#34; or &#34;even&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#fff">halveCounts</span> = <span style="color:#fff">weaver</span>.<span style="color:#fff">NewCounterMap</span>[<span style="color:#fff">halveLabels</span>](
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;halve_count&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;The number of values that have been halved&#34;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#fff">oddCount</span> = <span style="color:#fff">halveCounts</span>.<span style="color:#fff">Get</span>(<span style="color:#fff">halveLabels</span>{<span style="color:#e6db74">&#34;odd&#34;</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#fff">evenCount</span> = <span style="color:#fff">halveCounts</span>.<span style="color:#fff">Get</span>(<span style="color:#fff">halveLabels</span>{<span style="color:#e6db74">&#34;even&#34;</span>})
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">Halver</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Halve</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">halver</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Halver</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">halver</span>) <span style="color:#fff">Halve</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">val</span> <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#fff">val</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">evenCount</span>.<span style="color:#fff">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">oddCount</span>.<span style="color:#fff">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#fff">val</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>To adhere to <a href="https://prometheus.io/docs/practices/naming/">popular metric naming conventions</a>, Service
Weaver lowercases the first letter of every label by default. The <code>Parity</code> field
for example is exported as <code>parity</code>. You can override this behavior and provide
a custom label name using a <code>weaver</code> annotation.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">labels</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Foo</span> <span style="color:#66d9ef">string</span>                           <span style="color:#75715e">// exported as &#34;foo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">Bar</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`weaver:&#34;my_custom_name&#34;`</span> <span style="color:#75715e">// exported as &#34;my_custom_name&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre><h2>Auto-Generated Metrics</h2>
<p>Service Weaver automatically creates and maintains the following set of metrics, which
measure the count, latency, and chattiness of every remote component method
invocation. Every metric is labeled by the calling component as well as the
invoked component and method.</p>
<ul>
<li><code>serviceweaver_remote_method_count</code>: Count of Service Weaver component
method invocations.</li>
<li><code>serviceweaver_remote_method_error_count</code>: Count of Service Weaver component
method invocations that result in an error.</li>
<li><code>serviceweaver_remote_method_latency_micros</code>: Duration, in microseconds, of
Service Weaver component method execution.</li>
<li><code>serviceweaver_remote_method_bytes_request</code>: Number of bytes in Service
Weaver component method requests.</li>
<li><code>serviceweaver_remote_method_bytes_reply</code>: Number of bytes in Service Weaver
component method replies.</li>
</ul>
<p><strong>Note</strong>: These metrics only measure <em>remote</em> method calls. Local method calls,
like those between two co-located components, are not measured.</p>
<h2>HTTP Metrics</h2>
<p>Service Weaver declares the following set of HTTP related metrics.</p>
<ul>
<li><code>serviceweaver_http_request_count</code>: Count of HTTP requests.</li>
<li><code>serviceweaver_http_error_count</code>: Count of HTTP requests resulting in a 4XX or 5XX
response. This metric is also labeled with the returned status code.</li>
<li><code>serviceweaver_http_request_latency_micros</code>: Duration, in microseconds, of HTTP
request execution.</li>
<li><code>serviceweaver_http_request_bytes_received</code>: Estimated number of bytes <em>received</em> by
an HTTP handler.</li>
<li><code>serviceweaver_http_request_bytes_returned</code>: Estimated number of bytes <em>returned</em> by
an HTTP handler.</li>
</ul>
<p>If you pass an <a href="https://pkg.go.dev/net/http#Handler"><code>http.Handler</code></a> to the
<code>weaver.InstrumentHandler</code> function, it will return a new <code>http.Handler</code> that
updates these metrics automatically, labeled with the provided label. For
example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#75715e">// Metrics are recorded for fooHandler with label &#34;foo&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#fff">mux</span> <span style="color:#fff">http</span>.<span style="color:#fff">ServeMux</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#fff">fooHandler</span> <span style="color:#fff">http</span>.<span style="color:#fff">Handler</span> = <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#fff">mux</span>.<span style="color:#fff">Handle</span>(<span style="color:#e6db74">&#34;/foo&#34;</span>, <span style="color:#fff">weaver</span>.<span style="color:#fff">InstrumentHandler</span>(<span style="color:#e6db74">&#34;foo&#34;</span>, <span style="color:#fff">fooHandler</span>))
</span></span></code></pre><h1>Tracing</h1>
<p>Service Weaver relies on <a href="https://opentelemetry.io/docs/instrumentation/go/getting-started/">OpenTelemetry</a> to trace your application.
Service Weaver exports these traces into the environment where your application
is deployed. If you <a href="#gke">deploy a Service Weaver application to Google Cloud</a>,
for example, traces are automatically exported to <a href="https://cloud.google.com/trace">Google Cloud
Trace</a>. Here's an example of how to enable tracing for a simple
<code>Hello, World!</code> application.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/ServiceWeaver/weaver&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#fff">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get a network listener on address &#34;localhost:12345&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">root</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weaver</span>.<span style="color:#fff">Init</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Background</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#fff">opts</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weaver</span>.<span style="color:#fff">ListenerOptions</span>{<span style="color:#fff">LocalAddress</span>: <span style="color:#e6db74">&#34;localhost:12345&#34;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#fff">lis</span>, <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">root</span>.<span style="color:#fff">Listener</span>(<span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#fff">opts</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#fff">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">log</span>.<span style="color:#fff">Fatal</span>(<span style="color:#fff">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff">fmt</span>.<span style="color:#fff">Printf</span>(<span style="color:#e6db74">&#34;hello listener available on %v\n&#34;</span>, <span style="color:#fff">lis</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Serve the /hello endpoint.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">http</span>.<span style="color:#fff">HandleFunc</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#fff">w</span> <span style="color:#fff">http</span>.<span style="color:#fff">ResponseWriter</span>, <span style="color:#fff">r</span> <span style="color:#f92672">*</span><span style="color:#fff">http</span>.<span style="color:#fff">Request</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">fmt</span>.<span style="color:#fff">Fprintf</span>(<span style="color:#fff">w</span>, <span style="color:#e6db74">&#34;Hello, %s!\n&#34;</span>, <span style="color:#fff">r</span>.<span style="color:#fff">URL</span>.<span style="color:#fff">Query</span>().<span style="color:#fff">Get</span>(<span style="color:#e6db74">&#34;name&#34;</span>))
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create an otel handler to enable tracing.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">otelHandler</span> <span style="color:#f92672">:=</span> <span style="color:#fff">otelhttp</span>.<span style="color:#fff">NewHandler</span>(<span style="color:#fff">http</span>.<span style="color:#fff">DefaultServeMux</span>, <span style="color:#e6db74">&#34;http&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff">http</span>.<span style="color:#fff">Serve</span>(<span style="color:#fff">lis</span>, <span style="color:#fff">otelHandler</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>This code does the following:</p>
<ul>
<li><code>http.HandleFunc(&quot;/hello&quot;, ...)</code> registers a handler with the default HTTP
mux, called <code>http.DefaultServeMux</code>.</li>
<li><code>otelhttp.NewHandler(http.DefaultServeMux, &quot;http&quot;)</code> returns a new HTTP handler
that wraps the default HTTP mux.</li>
<li><code>http.Serve(lis, otelHandler)</code> serves HTTP traffic on <code>lis</code> using the
OpenTelemetry handler.</li>
</ul>
<p>Using the OpenTelemetry HTTP handler enables tracing. Once tracing is enabled,
all HTTP requests and resulting component method calls will be automatically
traced. Service Weaver will collect and export the traces for you. Refer to the
deployer-specific documentation for <a href="#single-process-tracing">single process</a>,
<a href="#multiprocess-tracing">multiprocess</a>, and <a href="#gke-tracing">GKE</a> to learn about
deployer specific exporters.</p>
<p>The step above is all you need to get started with tracing. If you want to add
more application-specific details to your traces, you can add attributes,
events, and errors using the context passed to registered HTTP handlers and
component methods. For example, in our <code>hello</code> example, you can add an event as
follows:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#fff">http</span>.<span style="color:#fff">HandleFunc</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#fff">w</span> <span style="color:#fff">http</span>.<span style="color:#fff">ResponseWriter</span>, <span style="color:#fff">r</span> <span style="color:#f92672">*</span><span style="color:#fff">http</span>.<span style="color:#fff">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">fmt</span>.<span style="color:#fff">Fprintf</span>(<span style="color:#fff">w</span>, <span style="color:#e6db74">&#34;Hello, %s!\n&#34;</span>, <span style="color:#fff">r</span>.<span style="color:#fff">URL</span>.<span style="color:#fff">Query</span>().<span style="color:#fff">Get</span>(<span style="color:#e6db74">&#34;name&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#fff">trace</span>.<span style="color:#fff">SpanFromContext</span>(<span style="color:#fff">r</span>.<span style="color:#fff">Context</span>()).<span style="color:#fff">AddEvent</span>(<span style="color:#e6db74">&#34;writing response&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#fff">trace</span>.<span style="color:#fff">WithAttributes</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff">label</span>.<span style="color:#fff">String</span>(<span style="color:#e6db74">&#34;content&#34;</span>, <span style="color:#e6db74">&#34;hello &#34;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#fff">label</span>.<span style="color:#fff">String</span>(<span style="color:#e6db74">&#34;answer&#34;</span>, <span style="color:#fff">r</span>.<span style="color:#fff">URL</span>.<span style="color:#fff">Query</span>().<span style="color:#fff">Get</span>(<span style="color:#e6db74">&#34;name&#34;</span>)),
</span></span><span style="display:flex;"><span>        ))
</span></span><span style="display:flex;"><span>})
</span></span></code></pre><p>Refer to <a href="https://lightstep.com/blog/opentelemetry-go-all-you-need-to-know#adding-detail">OpenTelemetry Go: All you need to know</a> to learn
more about how to add more application-specific details to your traces.</p>
<h1>Profiling</h1>
<p>Service Weaver allows you to profile an entire Service Weaver application, even one that is
deployed in multiple processes across multiple machines. Service Weaver profiles every
individual binary and aggregates them into a single profile that captures the
performance of the application as a whole. Refer to the deployer-specific
documentation for details on how to collect profiles for <a href="#single-process-profiling">single
process</a>, <a href="#multiprocess-profiling">multiprocess</a>,
and <a href="#gke-profiling">GKE</a> deployments.</p>
<h1>Routing</h1>
<p>By default, when a client invokes a remote component's method, this method call
will be performed by one of possibly many component replicas, selected
arbitrarily. It is sometimes beneficial for method invocations to be routed to
<em>a particular</em> replica based on the arguments provided to the method. For
example, consider a <code>Cache</code> component that maintains an in-memory cache in front
of an underlying disk-backed key-value store:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">Cache</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Get</span>(<span style="color:#fff">ctx</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">key</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Put</span>(<span style="color:#fff">ctx</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">key</span>, <span style="color:#fff">value</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">cache</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Cache</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre><p>To increase the cache hit ratio, we may want to route every request for a given
key to the same replica. Service Weaver supports this affinity based routing by allowing
the application to specify a router type associated with the component
implementation. For example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">cacheRouter</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">cacheRouter</span>) <span style="color:#fff">Get</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> { <span style="color:#66d9ef">return</span> <span style="color:#fff">key</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">cacheRouter</span>) <span style="color:#fff">Put</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">key</span>, <span style="color:#fff">value</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> { <span style="color:#66d9ef">return</span> <span style="color:#fff">key</span> }
</span></span></code></pre><p>For every component method that needs to be routed (e.g., <code>Get</code> and <code>Put</code>), the
router type should implement an equivalent method (i.e., same name and
argument types) whose return type is the routing key. When a component's routed
method is invoked, its corresponding router method is invoked to produce a
routing key. Method invocations that produce the same key are routed to the same
replica.</p>
<p>A routing key can be</p>
<ul>
<li>any integer (e.g., <code>int</code>, <code>int32</code>), float (i.e. <code>float32</code>, <code>float64</code>), or
string; or</li>
<li>a struct where every field is an integer, float, or string (e.g., <code>struct{x int; y string}</code>).</li>
</ul>
<p>Every router method must return the same routing key type. The following, for
example, is invalid:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#75715e">// ERROR: Get returns a string, but Put returns an int.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#fff">cacheRouter</span>) <span style="color:#fff">Get</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> { <span style="color:#66d9ef">return</span> <span style="color:#fff">key</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">cacheRouter</span>) <span style="color:#fff">Put</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">key</span>, <span style="color:#fff">value</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">int</span> { <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">42</span> }
</span></span></code></pre><p>To associate a router with its component, embed a <code>weaver.WithRouter[T]</code> field in
the component implementation where <code>T</code> is the type of the router.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">cache</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Cache</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">WithRouter</span>[<span style="color:#fff">cacheRouter</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre><p><strong>NOTE</strong>: Routing is done on a best-effort basis. Service Weaver will try to route
method invocations with the same key to the same replica, but this is <em>not</em>
guaranteed. As a corollary, you should <em>never</em> depend on routing for
correctness. Only use routing to increase performance in the common case.</p>
<p>Also note that if a component invokes a method on a co-located component, the
method call will always be executed by the co-located component and won't be
routed.</p>
<h1>Storage</h1>
<p>We expect most Service Weaver applications to persist their data in some way. For
example, an e-commerce application may store its products catalog and user
information in a database and access them while serving user requests.</p>
<p>By default, Service Weaver leaves the storage and retrieval of application data
up to the developer. If you're using a database, for example, you have to create
the database, pre-populate it with data, and write the code to access the
database from your Service Weaver application.</p>
<p>Below is an example of how database information can be passed to a simple
<code>Adder</code> component using a <a href="#components-config">config file</a>. First, the config
file:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[<span style="color:#e6db74">&#34;example.com/mypkg/Adder&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">Driver</span> = <span style="color:#e6db74">&#34;mysql&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff">Source</span> = <span style="color:#e6db74">&#34;root:@tcp(localhost:3306)/&#34;</span>
</span></span></code></pre><p>And the application that uses it:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">Adder</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Add</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">adder</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">Implements</span>[<span style="color:#fff">Adder</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">WithConfig</span>[<span style="color:#fff">config</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff">db</span> <span style="color:#f92672">*</span><span style="color:#fff">sql</span>.<span style="color:#fff">DB</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">config</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">Driver</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">// Name of the DB driver.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">Source</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">// DB data source.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">a</span> <span style="color:#f92672">*</span><span style="color:#fff">adder</span>) <span style="color:#fff">Init</span>(<span style="color:#fff">_</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">db</span>, <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">sql</span>.<span style="color:#fff">Open</span>(<span style="color:#fff">a</span>.<span style="color:#fff">Config</span>().<span style="color:#fff">Driver</span>, <span style="color:#fff">a</span>.<span style="color:#fff">Config</span>().<span style="color:#fff">Source</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff">r</span>.<span style="color:#fff">db</span> = <span style="color:#fff">db</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#fff">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#fff">a</span> <span style="color:#f92672">*</span><span style="color:#fff">Adder</span>) <span style="color:#fff">Add</span>(<span style="color:#fff">ctx</span> <span style="color:#fff">context</span>.<span style="color:#fff">Context</span>, <span style="color:#fff">x</span>, <span style="color:#fff">y</span> <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check in the database first.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#fff">sum</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#fff">q</span> = <span style="color:#e6db74">&#34;SELECT sum FROM table WHERE x=? AND y=?;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">r</span>.<span style="color:#fff">db</span>.<span style="color:#fff">QueryRowContext</span>(<span style="color:#fff">ctx</span>, <span style="color:#fff">q</span>, <span style="color:#fff">x</span>, <span style="color:#fff">y</span>).<span style="color:#fff">Scan</span>(<span style="color:#f92672">&amp;</span><span style="color:#fff">sum</span>); <span style="color:#fff">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#fff">sum</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Make a best-effort attempt to store in the database.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">q</span> = <span style="color:#e6db74">&#34;INSERT INTO table(x, y, sum) VALUES (?, ?, ?);&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff">r</span>.<span style="color:#fff">db</span>.<span style="color:#fff">ExecContext</span>(<span style="color:#fff">ctx</span>, <span style="color:#fff">q</span>, <span style="color:#fff">x</span>, <span style="color:#fff">y</span>, <span style="color:#fff">x</span> <span style="color:#f92672">+</span> <span style="color:#fff">y</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#fff">x</span> <span style="color:#f92672">+</span> <span style="color:#fff">y</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>A similar process can be followed to pass database information using Go flags or
environment variables.</p>
<h1>Testing</h1>
<p>Service Weaver includes a <code>weavertest</code> package that you can use to test your
Service Weaver applications. Use <code>weavertest.Init</code> as a drop-in replacement for
<code>weaver.Init</code>. To test an <code>Adder</code> component  with an <code>Add</code> method, for example,
create an <code>adder_test.go</code> file with the following contents.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#fff">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/ServiceWeaver/weaver&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/ServiceWeaver/weaver/weavertest&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#fff">TestAdd</span>(<span style="color:#fff">t</span> <span style="color:#f92672">*</span><span style="color:#fff">testing</span>.<span style="color:#fff">T</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#fff">context</span>.<span style="color:#fff">Background</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fff">root</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weavertest</span>.<span style="color:#fff">Init</span>(<span style="color:#fff">ctx</span>, <span style="color:#fff">t</span>, <span style="color:#fff">weavertest</span>.<span style="color:#fff">Options</span>{})
</span></span><span style="display:flex;"><span>    <span style="color:#fff">adder</span>, <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weaver</span>.<span style="color:#fff">Get</span>[<span style="color:#fff">Adder</span>](<span style="color:#fff">root</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#fff">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">t</span>.<span style="color:#fff">Fatal</span>(<span style="color:#fff">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff">got</span>, <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">adder</span>.<span style="color:#fff">Add</span>(<span style="color:#fff">ctx</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#fff">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">t</span>.<span style="color:#fff">Fatal</span>(<span style="color:#fff">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#fff">want</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">3</span>; <span style="color:#fff">got</span> <span style="color:#f92672">!=</span> <span style="color:#fff">want</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">t</span>.<span style="color:#fff">Fatalf</span>(<span style="color:#e6db74">&#34;got %q, want %q&#34;</span>, <span style="color:#fff">got</span>, <span style="color:#fff">want</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Run <code>go test</code> to run the test. <code>weavertest.Init</code> receives a <code>weavertest.Options</code>,
which you can use to configure the execution of the test. By default,
<code>weavertest.Init</code> will run every component in a different process. This is
similar to what happens when you run <code>weaver multi deploy</code>. If you set the
<code>SingleProcess</code> option, <code>weavertest.Init</code> will instead run every component in a
single process, similar to what happens when you <code>go run</code> a Service Weaver application.
You can test in both single and multiprocess mode to ensure that your components
work whether they are co-located in the same process or distributed across
multiple processes.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#fff">TestAdd</span>(<span style="color:#fff">t</span> <span style="color:#f92672">*</span><span style="color:#fff">testing</span>.<span style="color:#fff">T</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#fff">_</span>, <span style="color:#fff">single</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> []<span style="color:#66d9ef">bool</span>{<span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>} {
</span></span><span style="display:flex;"><span>        <span style="color:#fff">t</span>.<span style="color:#fff">Run</span>(<span style="color:#fff">fmt</span>.<span style="color:#fff">Sprintf</span>(<span style="color:#e6db74">&#34;Single=%t&#34;</span>, <span style="color:#fff">single</span>), <span style="color:#66d9ef">func</span>(<span style="color:#fff">t</span> <span style="color:#f92672">*</span><span style="color:#fff">testing</span>.<span style="color:#fff">T</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff">opts</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weavertest</span>.<span style="color:#fff">Options</span>{<span style="color:#fff">SingleProcess</span>: <span style="color:#fff">single</span>}
</span></span><span style="display:flex;"><span>            <span style="color:#fff">root</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weavertest</span>.<span style="color:#fff">Init</span>(<span style="color:#fff">context</span>.<span style="color:#fff">Background</span>(), <span style="color:#fff">t</span>, <span style="color:#fff">opts</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#fff">adder</span>, <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weaver</span>.<span style="color:#fff">Get</span>[<span style="color:#fff">Adder</span>](<span style="color:#fff">root</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>You can also provide the contents of a <a href="#config-files">config file</a> using the
<code>Config</code> field of the <code>weavertest.Options</code> struct.</p>
<div hidden class="todo">
TODO(mwhittaker): Explain how you can unit test a component directly, but it's
not as recommended.
</div>
<h1>Versioning</h1>
<p>Serving systems evolve over time. Whether you're fixing bugs or adding new
features, it is inevitable that you will have to roll out a new version of your
system to replace the currently running version. To maintain the availability of
their systems, people typically perform <strong>rolling updates</strong>, where the nodes in
a deployment are updated from the old version to the new version one by one.</p>
<p>During a rolling update, nodes running the old version of the code will have to
communicate with other nodes running the new version of the code. Ensuring that
a system is correct despite the possibility of these cross-version interactions
is very challenging. In
<a href="https://scholar.google.com/scholar?cluster=4116586908204898847"><em>Understanding and Detecting Software Upgrade Failures in Distributed Systems</em></a>,
Zhang et al. perform a case study of 123 failed updates in 8 widely used
systems. They found that the majority of failures were caused by the
interactions between multiple versions of a system:</p>
<blockquote>
<p><em>About two thirds of update failures are caused by interaction between two
software versions that hold incompatible data syntax or semantics
assumption.</em></p>
</blockquote>
<p>Service Weaver takes a different approach to rollouts and sidesteps these
complex cross-version interactions. Service Weaver ensures that client requests
are executed entirely within a single version of a system. A component in one
version will <em>never</em> communicate with a component in a different version. This
eliminates the leading cause of update failures, allowing you to roll out new
versions of your Service Weaver application safely and with less headache.</p>
<p>Avoiding cross-version communication is trivial for applications deployed using
<a href="#single-process"><code>go run</code></a> or <a href="#multiprocess"><code>weaver multi deploy</code></a> because
every deployment runs independently from one another. Refer to the
<a href="#gke-multi-region">GKE Deployments</a> and
<a href="#gke-versioning">GKE Versioning</a> sections to learn how Service Weaver uses a combination
of <a href="https://docs.aws.amazon.com/whitepapers/latest/overview-deployment-options/bluegreen-deployments.html">blue/green deployments</a> and autoscaling to slowly shift traffic
from an old version of a Service Weaver application running on GKE to a new version,
avoiding cross-version communication in a resource-efficient manner.</p>
<h1>Single Process</h1>
<h2>Getting Started</h2>
<p>The simplest and easiest way to deploy a Service Weaver application is to run it
directly via <code>go run</code>. When you <code>go run</code> a Service Weaver application, every
component is co-located in a single process, and method calls between components
are executed as regular Go method calls. Refer to the <a href="#step-by-step-tutorial">Step by Step
Tutorial</a> section for a full example.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go run .
</span></span></code></pre><p>You can run <code>weaver single status</code> to view the status of all active Service
Weaver applications deployed using <code>go run</code>.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver single status
</span></span><span style="display:flex;"><span>╭────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ DEPLOYMENTS                                        │
</span></span><span style="display:flex;"><span>├───────┬──────────────────────────────────────┬─────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT                           │ AGE │
</span></span><span style="display:flex;"><span>├───────┼──────────────────────────────────────┼─────┤
</span></span><span style="display:flex;"><span>│ hello │ a4bba25b-6312-4af1-beec-447c33b8e805 │ 26s │
</span></span><span style="display:flex;"><span>│ hello │ a4d4c71b-a99f-4ade-9586-640bd289158f │ 19s │
</span></span><span style="display:flex;"><span>│ hello │ bc663a25-c70e-440d-b022-04a83708c616 │ 12s │
</span></span><span style="display:flex;"><span>╰───────┴──────────────────────────────────────┴─────╯
</span></span><span style="display:flex;"><span>╭─────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ COMPONENTS                                          │
</span></span><span style="display:flex;"><span>├───────┬────────────┬─────────────────┬──────────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT │ COMPONENT       │ REPLICA PIDS │
</span></span><span style="display:flex;"><span>├───────┼────────────┼─────────────────┼──────────────┤
</span></span><span style="display:flex;"><span>│ hello │ a4bba25b   │ main            │ 123450       │
</span></span><span style="display:flex;"><span>│ hello │ a4bba25b   │ hello.Reverser  │ 123450       │
</span></span><span style="display:flex;"><span>│ hello │ a4d4c71b   │ main            │ 903510       │
</span></span><span style="display:flex;"><span>│ hello │ a4d4c71b   │ hello.Reverser  │ 903510       │
</span></span><span style="display:flex;"><span>│ hello │ bc663a25   │ main            │ 489102       │
</span></span><span style="display:flex;"><span>│ hello │ bc663a25   │ hello.Reverser  │ 489102       │
</span></span><span style="display:flex;"><span>╰───────┴────────────┴─────────────────┴──────────────╯
</span></span><span style="display:flex;"><span>╭────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ LISTENERS                                  │
</span></span><span style="display:flex;"><span>├───────┬────────────┬──────────┬────────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT │ LISTENER │ ADDRESS    │
</span></span><span style="display:flex;"><span>├───────┼────────────┼──────────┼────────────┤
</span></span><span style="display:flex;"><span>│ hello │ a4bba25b   │ hello    │ [::]:33541 │
</span></span><span style="display:flex;"><span>│ hello │ a4d4c71b   │ hello    │ [::]:41619 │
</span></span><span style="display:flex;"><span>│ hello │ bc663a25   │ hello    │ [::]:33319 │
</span></span><span style="display:flex;"><span>╰───────┴────────────┴──────────┴────────────╯
</span></span></code></pre><p>You can also run <code>weaver single dashboard</code> to open a dashboard in a web browser.</p>
<h2>Listeners</h2>
<p>You can call the <code>Listener</code> method on a <code>weaver.Instance</code> to get a network
listener (see the <a href="#step-by-step-tutorial">Step by Step Tutorial</a> section for
context).</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#fff">opts</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weaver</span>.<span style="color:#fff">ListenerOptions</span>{<span style="color:#fff">LocalAddress</span>: <span style="color:#e6db74">&#34;localhost:12345&#34;</span>}
</span></span><span style="display:flex;"><span><span style="color:#fff">lis</span>, <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">root</span>.<span style="color:#fff">Listener</span>(<span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#fff">opts</span>)
</span></span></code></pre><p>When you deploy an application using <code>go run</code>, the <code>Listener</code> method returns a
listener on the address specified by the <code>LocalAddress</code> field of the
<code>ListenerOptions</code> struct. In this way, the <code>Listener</code> method behaves pretty much
identically to the built-in <a href="https://pkg.go.dev/net#Listen"><code>net.Listen</code></a>.</p>
<h2>Logging</h2>
<p>When you deploy a Service Weaver application with <code>go run</code>, <a href="#logging">logs</a> are
printed to standard out. These logs are not persisted. You can optionally save
the logs for later analysis using basic shell constructs:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go run . | tee mylogs.txt
</span></span></code></pre><h2>Metrics</h2>
<p>Run <code>weaver single dashboard</code> to open a dashboard in a web browser. The
dashboard has a page for every Service Weaver application deployed via <code>go run .</code>.  Every deployment's page has a link to the deployment's <a href="#metrics">metrics</a>.
The metrics are exported in <a href="https://prometheus.io">Prometheus format</a> and looks something
like this:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span># Metrics in Prometheus text format [1].
</span></span><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span># To visualize and query the metrics, make sure Prometheus is installed on
</span></span><span style="display:flex;"><span># your local machine and then add the following stanza to your Prometheus yaml
</span></span><span style="display:flex;"><span># config file:
</span></span><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span># scrape_configs:
</span></span><span style="display:flex;"><span># - job_name: &#39;prometheus-serviceweaver-scraper&#39;
</span></span><span style="display:flex;"><span>#   scrape_interval: 5s
</span></span><span style="display:flex;"><span>#   metrics_path: /debug/serviceweaver/prometheus
</span></span><span style="display:flex;"><span>#   static_configs:
</span></span><span style="display:flex;"><span>#     - targets: [&#39;127.0.0.1:43087&#39;]
</span></span><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span># [1]: https://prometheus.io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP example_count An example counter.
</span></span><span style="display:flex;"><span># TYPE example_count counter
</span></span><span style="display:flex;"><span>example_count{serviceweaver_node=&#34;bbc9beb5&#34;} 42
</span></span><span style="display:flex;"><span>example_count{serviceweaver_node=&#34;00555c38&#34;} 9001
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># ┌─────────────────────────────────────┐
</span></span><span style="display:flex;"><span># │ SERVICEWEAVER AUTOGENERATED METRICS │
</span></span><span style="display:flex;"><span># └─────────────────────────────────────┘
</span></span><span style="display:flex;"><span># HELP serviceweaver_method_count Count of Service Weaver component method invocations
</span></span><span style="display:flex;"><span># TYPE serviceweaver_method_count counter
</span></span><span style="display:flex;"><span>serviceweaver_method_count{caller=&#34;main&#34;,component=&#34;main.Example&#34;,serviceweaver_node=&#34;9fa07495&#34;,method=&#34;Foo&#34;} 0
</span></span><span style="display:flex;"><span>serviceweaver_method_count{caller=&#34;main&#34;,component=&#34;main.Example&#34;,serviceweaver_node=&#34;ee76816d&#34;,method=&#34;Foo&#34;} 1
</span></span><span style="display:flex;"><span>...
</span></span></code></pre><p>As the header explains, you can visualize and query the metrics by installing
Prometheus and configuring it, using the provided stanza, to periodically scrape
the <code>/debug/serviceweaver/prometheus</code> endpoint of the provided target
(<code>127.0.0.1:43087</code> in the example above). You can also inspect the metrics
manually. The metrics page shows the latest value of every metric in your
application followed by <a href="#metrics-auto-generated-metrics">the metrics that Service Weaver automatically creates
for you</a>.</p>
<h2>Profiling</h2>
<p>Use the <code>weaver single profile</code> command to collect a profile of your Service Weaver
application. Invoke the command with the id of your deployment. For example,
imagine you <code>go run</code> your Service Weaver application and it gets a deployment id
<code>28807368-1101-41a3-bdcb-9625e0f02ca0</code>.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go run .
</span></span><span style="display:flex;"><span>╭───────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ app        : hello                                │
</span></span><span style="display:flex;"><span>│ deployment : 28807368-1101-41a3-bdcb-9625e0f02ca0 │
</span></span><span style="display:flex;"><span>╰───────────────────────────────────────────────────╯
</span></span></code></pre><p>In a separate terminal, you can run the <code>weaver single profile</code> command.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver single profile <span style="color:#ae81ff">28807368</span>               <span style="color:#75715e"># Collect a CPU profile.</span>
</span></span><span style="display:flex;"><span>$ weaver single profile --duration<span style="color:#f92672">=</span>1m <span style="color:#ae81ff">28807368</span> <span style="color:#75715e"># Adjust the duration of the profile.</span>
</span></span><span style="display:flex;"><span>$ weaver single profile --type<span style="color:#f92672">=</span>heap <span style="color:#ae81ff">28807368</span>   <span style="color:#75715e"># Collect a heap profile.</span>
</span></span></code></pre><p><code>weaver single profile</code> prints out the filename of the collected profile. You can
use the <code>go tool pprof</code> command to visualize and analyze the profile. For
example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ profile<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>weaver single profile &lt;deployment&gt;<span style="color:#66d9ef">)</span> <span style="color:#75715e"># Collect the profile.</span>
</span></span><span style="display:flex;"><span>$ go tool pprof -http<span style="color:#f92672">=</span>localhost:9000 $profile   <span style="color:#75715e"># Visualize the profile.</span>
</span></span></code></pre><p>Refer to <code>weaver single profile --help</code> for more details. Refer to <code>go tool pprof --help</code> for more information on how to use pprof to analyze your profiles. Refer
to <a href="https://go.dev/blog/pprof"><em>Profiling Go Programs</em></a> for a tutorial.</p>
<h2>Tracing</h2>
<p>Run <code>weaver single dashboard</code> to open a dashboard in a web browser. The
dashboard has a page for every Service Weaver application deployed via <code>go run .</code>.  Every deployment's page has a link to the deployment's <a href="#tracing">traces</a>
accessible via <a href="https://ui.perfetto.dev/">Perfetto</a>. Here's an example of what the tracing page
looks like:</p>
<p><img src="assets/images/trace_single.png" alt="An example trace page"></p>
<p>Refer to <a href="https://perfetto.dev/docs/visualization/perfetto-ui">Perfetto UI Docs</a>
to learn more about how to use the tracing UI.</p>
<h1>Multiprocess</h1>
<h2>Getting Started</h2>
<p>You can use <code>weaver multi</code> to deploy a Service Weaver application across
multiple processes on your local machine, with each component replica running in
a separate OS process. Create <a href="#config-files">a config file</a>, say <code>weaver.toml</code>,
that points to your compiled Service Weaver application.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[<span style="color:#fff">serviceweaver</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">binary</span> = <span style="color:#e6db74">&#34;./your_compiled_serviceweaver_binary&#34;</span>
</span></span></code></pre><p>Deploy the application using <code>weaver multi deploy</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver multi deploy weaver.toml
</span></span></code></pre><p>Refer to the <a href="#step-by-step-tutorial">Step by Step Tutorial</a> section for a full
example.</p>
<p>When <code>weaver multi deploy</code> terminates (e.g., when you press <code>ctrl+c</code>), the
application is destroyed and all processes are terminated.</p>
<p>You can run <code>weaver multi status</code> to view the status of all active Service Weaver
applications deployed using <code>weaver multi</code>.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver multi status
</span></span><span style="display:flex;"><span>╭────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ DEPLOYMENTS                                        │
</span></span><span style="display:flex;"><span>├───────┬──────────────────────────────────────┬─────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT                           │ AGE │
</span></span><span style="display:flex;"><span>├───────┼──────────────────────────────────────┼─────┤
</span></span><span style="display:flex;"><span>│ hello │ a4bba25b-6312-4af1-beec-447c33b8e805 │ 26s │
</span></span><span style="display:flex;"><span>│ hello │ a4d4c71b-a99f-4ade-9586-640bd289158f │ 19s │
</span></span><span style="display:flex;"><span>│ hello │ bc663a25-c70e-440d-b022-04a83708c616 │ 12s │
</span></span><span style="display:flex;"><span>╰───────┴──────────────────────────────────────┴─────╯
</span></span><span style="display:flex;"><span>╭───────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ COMPONENTS                                            │
</span></span><span style="display:flex;"><span>├───────┬────────────┬─────────────────┬────────────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT │ COMPONENT       │ REPLICA PIDS   │
</span></span><span style="display:flex;"><span>├───────┼────────────┼─────────────────┼────────────────┤
</span></span><span style="display:flex;"><span>│ hello │ a4bba25b   │ main            │ 695110, 695115 │
</span></span><span style="display:flex;"><span>│ hello │ a4bba25b   │ hello.Reverser  │ 193720, 398751 │
</span></span><span style="display:flex;"><span>│ hello │ a4d4c71b   │ main            │ 847020, 292745 │
</span></span><span style="display:flex;"><span>│ hello │ a4d4c71b   │ hello.Reverser  │ 849035, 897452 │
</span></span><span style="display:flex;"><span>│ hello │ bc663a25   │ main            │ 245702, 157455 │
</span></span><span style="display:flex;"><span>│ hello │ bc663a25   │ hello.Reverser  │ 997520, 225023 │
</span></span><span style="display:flex;"><span>╰───────┴────────────┴─────────────────┴────────────────╯
</span></span><span style="display:flex;"><span>╭────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ LISTENERS                                  │
</span></span><span style="display:flex;"><span>├───────┬────────────┬──────────┬────────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT │ LISTENER │ ADDRESS    │
</span></span><span style="display:flex;"><span>├───────┼────────────┼──────────┼────────────┤
</span></span><span style="display:flex;"><span>│ hello │ a4bba25b   │ hello    │ [::]:33541 │
</span></span><span style="display:flex;"><span>│ hello │ a4d4c71b   │ hello    │ [::]:41619 │
</span></span><span style="display:flex;"><span>│ hello │ bc663a25   │ hello    │ [::]:33319 │
</span></span><span style="display:flex;"><span>╰───────┴────────────┴──────────┴────────────╯
</span></span></code></pre><p>You can also run <code>weaver multi dashboard</code> to open a dashboard in a web browser.</p>
<h2>Listeners</h2>
<p>You can call the <code>Listener</code> method on a <code>weaver.Instance</code> to get a network
listener (see the <a href="#step-by-step-tutorial">Step by Step Tutorial</a> section for
context).</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#fff">opts</span> <span style="color:#f92672">:=</span> <span style="color:#fff">weaver</span>.<span style="color:#fff">ListenerOptions</span>{<span style="color:#fff">LocalAddress</span>: <span style="color:#e6db74">&#34;localhost:12345&#34;</span>}
</span></span><span style="display:flex;"><span><span style="color:#fff">lis</span>, <span style="color:#fff">err</span> <span style="color:#f92672">:=</span> <span style="color:#fff">root</span>.<span style="color:#fff">Listener</span>(<span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#fff">opts</span>)
</span></span></code></pre><p>When you deploy an application using <code>weaver multi deploy</code>, the <code>Listener</code>
method does two things.</p>
<ol>
<li>It returns a network listener listening on localhost on a random port chosen
by the operating system (i.e. listening on <code>localhost:0</code>).</li>
<li>It ensures that an HTTP proxy is running on the address specified by the
<code>LocalAddress</code> field of the <code>ListenerOptions</code> struct. This proxy forwards
traffic to the listener returned by <code>Listener</code>. In fact, the proxy balances
traffic across every replica of the listener. (Recall that components may be
replicated, and <code>Listener</code> is called once per replica.)</li>
</ol>
<h2>Logging</h2>
<p><code>weaver multi deploy</code> logs to stdout. It additionally persists all log entries in
a set of files in <code>/tmp/serviceweaver/logs/weaver-multi</code>. Every file contains a stream of
log entries encoded as protocol buffers. You can cat, follow, and filter these
logs using <code>weaver multi logs</code>. For example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#75715e"># Display all of the application logs</span>
</span></span><span style="display:flex;"><span>weaver multi logs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Follow all of the logs (similar to tail -f).</span>
</span></span><span style="display:flex;"><span>weaver multi logs --follow
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs for the &#34;todo&#34; app.</span>
</span></span><span style="display:flex;"><span>weaver multi logs <span style="color:#e6db74">&#39;app == &#34;todo&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the debug logs for the &#34;todo&#34; app.</span>
</span></span><span style="display:flex;"><span>weaver multi logs <span style="color:#e6db74">&#39;app==&#34;todo&#34; &amp;&amp; level==&#34;debug&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs for the &#34;todo&#34; app in files called foo.go.</span>
</span></span><span style="display:flex;"><span>weaver multi logs <span style="color:#e6db74">&#39;app==&#34;todo&#34; &amp;&amp; source.contains(&#34;foo.go&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs that contain the string &#34;error&#34;.</span>
</span></span><span style="display:flex;"><span>weaver multi logs <span style="color:#e6db74">&#39;msg.contains(&#34;error&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs that match a regex.</span>
</span></span><span style="display:flex;"><span>weaver multi logs <span style="color:#e6db74">&#39;msg.matches(&#34;error: file .* already closed&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs that have an attribute &#34;foo&#34; with value &#34;bar&#34;.</span>
</span></span><span style="display:flex;"><span>weaver multi logs <span style="color:#e6db74">&#39;attrs[&#34;foo&#34;] == &#34;bar&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs in JSON format. This is useful if you want to</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># perform some sort of post-processing on the logs.</span>
</span></span><span style="display:flex;"><span>weaver multi logs --format<span style="color:#f92672">=</span>json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs, including internal system logs that are hidden by</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># default.</span>
</span></span><span style="display:flex;"><span>weaver multi logs --system
</span></span></code></pre><p>Refer to <code>weaver multi logs --help</code> for a full explanation of the query language,
along with many more examples.</p>
<h2>Metrics</h2>
<p>Run <code>weaver multi dashboard</code> to open a dashboard in a web browser. The dashboard
has a page for every Service Weaver application deployed via <code>weaver muli deploy</code>.  Every deployment's page has a link to the deployment's
<a href="#metrics">metrics</a>. The metrics are exported in <a href="https://prometheus.io">Prometheus
format</a> and looks something like this:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span># Metrics in Prometheus text format [1].
</span></span><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span># To visualize and query the metrics, make sure Prometheus is installed on
</span></span><span style="display:flex;"><span># your local machine and then add the following stanza to your Prometheus yaml
</span></span><span style="display:flex;"><span># config file:
</span></span><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span># scrape_configs:
</span></span><span style="display:flex;"><span># - job_name: &#39;prometheus-serviceweaver-scraper&#39;
</span></span><span style="display:flex;"><span>#   scrape_interval: 5s
</span></span><span style="display:flex;"><span>#   metrics_path: /debug/serviceweaver/prometheus
</span></span><span style="display:flex;"><span>#   static_configs:
</span></span><span style="display:flex;"><span>#     - targets: [&#39;127.0.0.1:43087&#39;]
</span></span><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span># [1]: https://prometheus.io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP example_count An example counter.
</span></span><span style="display:flex;"><span># TYPE example_count counter
</span></span><span style="display:flex;"><span>example_count{serviceweaver_node=&#34;bbc9beb5&#34;} 42
</span></span><span style="display:flex;"><span>example_count{serviceweaver_node=&#34;00555c38&#34;} 9001
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># ┌─────────────────────────────────────┐
</span></span><span style="display:flex;"><span># │ SERVICEWEAVER AUTOGENERATED METRICS │
</span></span><span style="display:flex;"><span># └─────────────────────────────────────┘
</span></span><span style="display:flex;"><span># HELP serviceweaver_method_count Count of Service Weaver component method invocations
</span></span><span style="display:flex;"><span># TYPE serviceweaver_method_count counter
</span></span><span style="display:flex;"><span>serviceweaver_method_count{caller=&#34;main&#34;,component=&#34;main.Example&#34;,serviceweaver_node=&#34;9fa07495&#34;,method=&#34;Foo&#34;} 0
</span></span><span style="display:flex;"><span>serviceweaver_method_count{caller=&#34;main&#34;,component=&#34;main.Example&#34;,serviceweaver_node=&#34;ee76816d&#34;,method=&#34;Foo&#34;} 1
</span></span><span style="display:flex;"><span>...
</span></span></code></pre><p>As the header explains, you can visualize and query the metrics by installing
Prometheus and configuring it, using the provided stanza, to periodically scrape
the <code>/debug/serviceweaver/prometheus</code> endpoint of the provided target (e.g.,
<code>127.0.0.1:43087</code>). You can also inspect the metrics manually. The metrics page
shows the latest value of every metric in your application followed by <a href="#metrics-auto-generated-metrics">the
metrics that Service Weaver automatically creates for
you</a>.</p>
<h2>Profiling</h2>
<p>Use the <code>weaver multi profile</code> command to collect a profile of your Service Weaver
application. Invoke the command with the id of your deployment. For example,
imagine you <code>weaver multi deploy</code> your Service Weaver application and it gets a deployment
id <code>28807368-1101-41a3-bdcb-9625e0f02ca0</code>.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver multi deploy weaver.toml
</span></span><span style="display:flex;"><span>╭───────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ app        : hello                                │
</span></span><span style="display:flex;"><span>│ deployment : 28807368-1101-41a3-bdcb-9625e0f02ca0 │
</span></span><span style="display:flex;"><span>╰───────────────────────────────────────────────────╯
</span></span></code></pre><p>In a separate terminal, you can run the <code>weaver multi profile</code> command.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver multi profile <span style="color:#ae81ff">28807368</span>               <span style="color:#75715e"># Collect a CPU profile.</span>
</span></span><span style="display:flex;"><span>$ weaver multi profile --duration<span style="color:#f92672">=</span>1m <span style="color:#ae81ff">28807368</span> <span style="color:#75715e"># Adjust the duration of the profile.</span>
</span></span><span style="display:flex;"><span>$ weaver multi profile --type<span style="color:#f92672">=</span>heap <span style="color:#ae81ff">28807368</span>   <span style="color:#75715e"># Collect a heap profile.</span>
</span></span></code></pre><p><code>weaver multi profile</code> prints out the filename of the collected profile. You can
use the <code>go tool pprof</code> command to visualize and analyze the profile. For
example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ profile<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>weaver multi profile &lt;deployment&gt;<span style="color:#66d9ef">)</span> <span style="color:#75715e"># Collect the profile.</span>
</span></span><span style="display:flex;"><span>$ go tool pprof -http<span style="color:#f92672">=</span>localhost:9000 $profile <span style="color:#75715e"># Visualize the profile.</span>
</span></span></code></pre><p>Refer to <code>weaver multi profile --help</code> for more details. Refer to <code>go tool pprof --help</code> for more information on how to use pprof to analyze your profiles. Refer
to <a href="https://go.dev/blog/pprof"><em>Profiling Go Programs</em></a> for a tutorial.</p>
<h2>Tracing</h2>
<p>Run <code>weaver multi dashboard</code> to open a dashboard in a web browser. The
dashboard has a page for every Service Weaver application deployed via
<code>weaver multi deploy</code>. Every deployment's page has a link to the deployment's
<a href="#tracing">traces</a> accessible via <a href="https://ui.perfetto.dev/">Perfetto</a>. Here's an example of
what the tracing page looks like:</p>
<p><img src="assets/images/trace_multi.png" alt="An example trace page"></p>
<p>Trace events are grouped by colocation group and their corresponding replicas.
Each event has a label associated with it, based on whether the event was due to
a local or remote call. Note that the user can filter the set of events for a
particular trace by clicking on an event's <code>traceID</code> and choosing <code>Find slices with the same arg value</code>.</p>
<p>Refer to <a href="https://perfetto.dev/docs/visualization/perfetto-ui">Perfetto UI Docs</a>
to learn more about how to use the tracing UI.</p>
<h1>GKE</h1>
<p><a href="https://cloud.google.com/kubernetes-engine">Google Kubernetes Engine (GKE)</a> is a Google Cloud managed service that
implements the full <a href="https://kubernetes.io/">Kubernetes</a> API. It supports autoscaling and
multi-cluster development, and allows you to run containerized applications in
the cloud.</p>
<p>You can use <code>weaver gke</code> to deploy a Service Weaver application to GKE, with components
running on different machines across multiple cloud regions. The <code>weaver gke</code>
command does a lot of the heavy lifting to set up GKE on your behalf. It
containerizes your application; it creates the appropriate GKE clusters; it
plumbs together all the networking infrastructure; and so on. This makes
deploying your Service Weaver application to the cloud as easy as running <code>weaver gke deploy</code>. In this section, we show you how to deploy your application using
<code>weaver gke</code>. Refer to the <a href="#local-gke">Local GKE</a> section to see how to simulate
a GKE deployment locally on your machine.</p>
<h2>Installation</h2>
<p>First, <a href="#installation">ensure you have Service Weaver installed</a>. Next, install
the <code>weaver-gke</code> command:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go install github.com/ServiceWeaver/weaver-gke/cmd/weaver-gke@latest
</span></span></code></pre><p>Install the <code>gcloud</code> command to your local machine. To do so, follow <a href="https://cloud.google.com/sdk/docs/install">these
instructions</a>, or run the following command and follow its
prompts:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ curl https://sdk.cloud.google.com | bash
</span></span></code></pre><p>After installing <code>gcloud</code>, run the following command to initialize your local
environment:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ gcloud init
</span></span></code></pre><p>The above command will prompt you to select the Google account and cloud project
you wish to use. If you don't have a cloud project, the command will prompt you
to create one. Make sure to select a unique project name or the command will
fail. If that happens, follow <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects#gcloud">these instructions</a> to create
a new project, or simply run:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ gcloud projects create my-unique-project-name
</span></span></code></pre><p>Before you can use your cloud project, however, you must add a billing account
to it. Go to <a href="https://console.cloud.google.com/billing">this page</a> to create a new billing account, and
<a href="https://console.cloud.google.com/billing/projects">this page</a> to associate a billing account with your
cloud project.</p>
<div hidden class="todo">
TODO(mwhittaker): Explain how to set up a `/healthz` endpoint once we
finalize that design.
</div>
<h2>Getting Started</h2>
<p>Consider again the &quot;Hello, World!&quot; Service Weaver application from the <a href="#step-by-step-tutorial">Step by
Step Tutorial</a> section. The application runs an HTTP
server on a listener named <code>hello</code> with a <code>/hello?name=&lt;name&gt;</code> endpoint that
returns a <code>Hello, &lt;name&gt;!</code> greeting. To deploy this application to GKE, first
create a <a href="#config-files">Service Weaver config file</a>, say <code>weaver.toml</code>, with
the following contents:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[<span style="color:#fff">serviceweaver</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">binary</span> = <span style="color:#e6db74">&#34;./hello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#fff">gke</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">regions</span> = [<span style="color:#e6db74">&#34;us-west1&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">public_listener</span> = [
</span></span><span style="display:flex;"><span>  {<span style="color:#fff">name</span> = <span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#fff">hostname</span> = <span style="color:#e6db74">&#34;hello.com&#34;</span>},
</span></span><span style="display:flex;"><span>]
</span></span></code></pre><p>The <code>[serviceweaver]</code> section of the config file specifies the compiled Service Weaver binary.
The <code>[gke]</code> section configures the regions where the application is deployed
(<code>us-west1</code> in this example). It also declares which listeners should be
<strong>public</strong>, i.e., which listeners should be accessible from the public internet.
By default, all listeners are <strong>private</strong>, i.e., accessible only from the cloud
project's internal network. In our example, we declare that the <code>hello</code> listener
is public.</p>
<p>Deploy the application using <code>weaver gke deploy</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver gke deploy weaver.toml
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Deploying the application... Done
</span></span><span style="display:flex;"><span>Version &#34;8e1c640a-d87b-4020-b3dd-4efc1850756c&#34; of app &#34;hello&#34; started successfully.
</span></span><span style="display:flex;"><span>Note that stopping this binary will not affect the app in any way.
</span></span><span style="display:flex;"><span>Tailing the logs...
</span></span><span style="display:flex;"><span>...
</span></span></code></pre><p>The first time you deploy a Service Weaver application to a cloud project, the process
may be slow, since Service Weaver needs to configure your cloud project, create the
appropriate GKE clusters, etc. Subsequent deployments should be significantly
faster.</p>
<p>When <code>weaver gke</code> deploys your application, it creates a global, externally
accessibly load balancer that forwards traffic to the public listeners in your
application. <code>weaver gke deploy</code> prints out the IP address of this load balancer
as well as instructions on how to interact with it:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>NOTE: The applications&#39; public listeners will be accessible via an
</span></span><span style="display:flex;"><span>L7 load-balancer managed by Service Weaver running at the public IP address:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    http://34.149.225.62
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>This load-balancer uses hostname-based routing to route request to the
</span></span><span style="display:flex;"><span>appropriate listeners. As a result, all HTTP(s) requests reaching this
</span></span><span style="display:flex;"><span>load-balancer must have the correct &#34;Host&#34; header field populated. This can be
</span></span><span style="display:flex;"><span>achieved in one of two ways:
</span></span><span style="display:flex;"><span>...
</span></span></code></pre><p>For an application running in production, you will likely want to configure DNS
to map your domain name (e.g. <code>hello.com</code>), to the address of the load balancer
(e.g., <code>http://34.149.225.62</code>). When testing and debugging an application,
however, we can also simply curl the load balancer with the appropriate hostname
header. Since we configured our application to associate host name <code>hello.com</code>
with the <code>hello</code> listener, we use the following command:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ curl --header <span style="color:#e6db74">&#39;Host: hello.com&#39;</span> http://34.149.225.63/hello?name<span style="color:#f92672">=</span>Weaver
</span></span><span style="display:flex;"><span>Hello, Weaver!
</span></span></code></pre><p>We can inspect the Service Weaver applications running on GKE using the <code>weaver gke status</code> command.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver gke status
</span></span><span style="display:flex;"><span>╭───────────────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ Deployments                                                   │
</span></span><span style="display:flex;"><span>├───────┬──────────────────────────────────────┬───────┬────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT                           │ AGE   │ STATUS │
</span></span><span style="display:flex;"><span>├───────┼──────────────────────────────────────┼───────┼────────┤
</span></span><span style="display:flex;"><span>│ hello │ 20c1d756-80b5-42a7-9e73-b0d3e717516e │ 1m10s │ ACTIVE │
</span></span><span style="display:flex;"><span>╰───────┴──────────────────────────────────────┴───────┴────────╯
</span></span><span style="display:flex;"><span>╭──────────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ COMPONENTS                                               │
</span></span><span style="display:flex;"><span>├───────┬────────────┬──────────┬────────────────┬─────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT │ LOCATION │ COMPONENT      │ HEALTHY │
</span></span><span style="display:flex;"><span>├───────┼────────────┼──────────┼────────────────┼─────────┤
</span></span><span style="display:flex;"><span>│ hello │ 20c1d756   │ us-west1 │ hello.Reverser │ 2/2     │
</span></span><span style="display:flex;"><span>│ hello │ 20c1d756   │ us-west1 │ main           │ 2/2     │
</span></span><span style="display:flex;"><span>╰───────┴────────────┴──────────┴────────────────┴─────────╯
</span></span><span style="display:flex;"><span>╭─────────────────────────────────────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ TRAFFIC                                                                             │
</span></span><span style="display:flex;"><span>├───────────┬────────────┬───────┬────────────┬──────────┬─────────┬──────────────────┤
</span></span><span style="display:flex;"><span>│ HOST      │ VISIBILITY │ APP   │ DEPLOYMENT │ LOCATION │ ADDRESS │ TRAFFIC FRACTION │
</span></span><span style="display:flex;"><span>├───────────┼────────────┼───────┼────────────┼──────────┼─────────┼──────────────────┤
</span></span><span style="display:flex;"><span>│ hello.com │ public     │ hello │ 20c1d756   │ us-west1 │         │ 0.5              │
</span></span><span style="display:flex;"><span>├───────────┼────────────┼───────┼────────────┼──────────┼─────────┼──────────────────┤
</span></span><span style="display:flex;"><span>│ hello.com │ public     │ hello │ 20c1d756   │ us-west1 │         │ 0.5              │
</span></span><span style="display:flex;"><span>╰───────────┴────────────┴───────┴────────────┴──────────┴─────────┴──────────────────╯
</span></span><span style="display:flex;"><span>╭────────────────────────────╮
</span></span><span style="display:flex;"><span>│ ROLLOUT OF hello           │
</span></span><span style="display:flex;"><span>├─────────────────┬──────────┤
</span></span><span style="display:flex;"><span>│                 │ us-west1 │
</span></span><span style="display:flex;"><span>├─────────────────┼──────────┤
</span></span><span style="display:flex;"><span>│ TIME            │ 20c1d756 │
</span></span><span style="display:flex;"><span>│ Feb 27 21:23:07 │ 1.00     │
</span></span><span style="display:flex;"><span>╰─────────────────┴──────────╯
</span></span></code></pre><p><code>weaver gke status</code> reports information about every app, deployment, component,
and listener in your cloud project. In this example, we have a single deployment
(with id <code>20c1d756</code>) of the <code>hello</code> app. Our app has two components (<code>main</code> and
<code>hello.Reverser</code>) each with two healthy replicas running in the <code>us-west1</code>
region. The two replicas of the <code>main</code> component each export a <code>hello</code> listener.
The global load balancer that we curled earlier balances traffic evenly across
these two listeners. The final section of the output details the rollout
schedule of the application. We'll discuss rollouts later in the
<a href="#gke-multi-region">Rollouts</a> section. You can also run <code>weaver gke dashboard</code>
to open a dashboard in a web browser.</p>
<div hidden class="todo">
TODO(mwhittaker): Remove rollout section?
</div>
<p><strong>Note</strong>: <code>weaver gke</code> configures GKE to autoscale your application. As the load
on your application increases, the number of replicas of the overloaded
components will increase. Conversely, as the load on your application decreases,
the number of replicas decreases. Service Weaver can independently scale the different
components of your application, meaning that heavily loaded components can be
scaled up while lesser loaded components can simultaneously be scaled down.</p>
<p>You can use the <code>weaver gke kill</code> command to kill your deployed application.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver gke kill hello
</span></span><span style="display:flex;"><span>WARNING: You are about to kill every active deployment of the &#34;hello&#34; app.
</span></span><span style="display:flex;"><span>The deployments will be killed immediately and irrevocably. Are you sure you
</span></span><span style="display:flex;"><span>want to proceed?
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>Enter (y)es to continue: y
</span></span></code></pre><h2>Logging</h2>
<p><code>weaver gke deploy</code> logs to stdout. It additionally exports all log entries to
<a href="https://cloud.google.com/logging">Cloud Logging</a>.  You can cat, follow, and filter these logs from
the command line using <code>weaver gke logs</code>. For example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#75715e"># Display all of the application logs</span>
</span></span><span style="display:flex;"><span>weaver gke logs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Follow all of the logs (similar to tail -f).</span>
</span></span><span style="display:flex;"><span>weaver gke logs --follow
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs for the &#34;todo&#34; app.</span>
</span></span><span style="display:flex;"><span>weaver gke logs <span style="color:#e6db74">&#39;app == &#34;todo&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the debug logs for the &#34;todo&#34; app.</span>
</span></span><span style="display:flex;"><span>weaver gke logs <span style="color:#e6db74">&#39;app==&#34;todo&#34; &amp;&amp; level==&#34;debug&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs for the &#34;todo&#34; app in files called foo.go.</span>
</span></span><span style="display:flex;"><span>weaver gke logs <span style="color:#e6db74">&#39;app==&#34;todo&#34; &amp;&amp; source.contains(&#34;foo.go&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs that contain the string &#34;error&#34;.</span>
</span></span><span style="display:flex;"><span>weaver gke logs <span style="color:#e6db74">&#39;msg.contains(&#34;error&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs that match a regex.</span>
</span></span><span style="display:flex;"><span>weaver gke logs <span style="color:#e6db74">&#39;msg.matches(&#34;error: file .* already closed&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs that have an attribute &#34;foo&#34; with value &#34;bar&#34;.</span>
</span></span><span style="display:flex;"><span>weaver gke logs <span style="color:#e6db74">&#39;attrs[&#34;foo&#34;] == &#34;bar&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs in JSON format. This is useful if you want to</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># perform some sort of post-processing on the logs.</span>
</span></span><span style="display:flex;"><span>weaver gke logs --format<span style="color:#f92672">=</span>json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs, including internal system logs that are hidden by</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># default.</span>
</span></span><span style="display:flex;"><span>weaver gke logs --system
</span></span></code></pre><p>Refer to <code>weaver gke logs --help</code> for a full explanation of the query language,
along with many more examples.</p>
<p>You can also run <code>weaver gke dashboard</code> to open a dashboard in a web browser.
The dashboard has a page for every Service Weaver application deployed via
<code>weaver gke deploy</code>. Every deployment's page has a link to the deployment's logs
on <a href="https://cloud.google.com/logging/docs/view/logs-explorer-interface">Google Cloud's Logs Explorer</a> as shown below.</p>
<p><img src="assets/images/logs_explorer.png" alt="A screenshot of Service Weaver logs in the Logs Explorer"></p>
<h2>Metrics</h2>
<p><code>weaver gke</code> exports metrics to the
<a href="https://cloud.google.com/monitoring/api/metrics_gcp">Google Cloud Monitoring console</a>. You can view and graph these
metrics using the <a href="https://cloud.google.com/monitoring/charts/metrics-explorer">Cloud Metrics Explorer</a>. When you open the
Metrics Explorer, click <code>SELECT A METRIC</code>.</p>
<p><img src="assets/images/cloud_metrics_1.png" alt="A screenshot of the Metrics Explorer"></p>
<p>All Service Weaver metrics are exported under the <code>custom.googleapis.com</code> domain. Query
for <code>serviceweaver</code> to view these metrics and select the metric you're interested in.</p>
<p><img src="assets/images/cloud_metrics_2.png" alt="A screenshot of selecting a metric in Metrics Explorer"></p>
<p>You can use the Metrics Explorer to graph the metric you selected.</p>
<p><img src="assets/images/cloud_metrics_3.png" alt="A screenshot of a metric graph in Metrics Explorer"></p>
<p>Refer to the <a href="https://cloud.google.com/monitoring/api/metrics_gcp">Cloud Metrics</a> documentation for more information.</p>
<h2>Profiling</h2>
<p>Use the <code>weaver gke profile</code> command to collect a profile of your Service Weaver
application. Invoke the command with the name (and optionally version) of the
app you wish to profile. For example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span># Collect a CPU profile of the latest version of the hello app.
</span></span><span style="display:flex;"><span>$ weaver gke profile hello
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span># Collect a CPU profile of a specific version of the hello app.
</span></span><span style="display:flex;"><span>$ weaver gke profile --version<span style="color:#f92672">=</span>8e1c640a-d87b-4020-b3dd-4efc1850756c hello
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span># Adjust the duration of a CPU profile.
</span></span><span style="display:flex;"><span>$ weaver gke profile --duration<span style="color:#f92672">=</span>1m hello
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span># Collect a heap profile.
</span></span><span style="display:flex;"><span>$ weaver gke profile --type<span style="color:#f92672">=</span>heap hello
</span></span></code></pre><p><code>weaver gke profile</code> prints out the filename of the collected profile. You can
use the <code>go tool pprof</code> command to visualize and analyze the profile. For
example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ profile<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>weaver gke profile &lt;app&gt;<span style="color:#66d9ef">)</span>         <span style="color:#75715e"># Collect the profile.</span>
</span></span><span style="display:flex;"><span>$ go tool pprof -http<span style="color:#f92672">=</span>localhost:9000 $profile <span style="color:#75715e"># Visualize the profile.</span>
</span></span></code></pre><p>Refer to <code>weaver gke profile --help</code> for more details.</p>
<h2>Tracing</h2>
<p>Run <code>weaver gke dashboard</code> to open a dashboard in a web browser. The
dashboard has a page for every Service Weaver application deployed via
<code>weaver gke deploy</code>. Every deployment's page has a link to the deployment's
<a href="#tracing">traces</a> accessible via <a href="https://cloud.google.com/trace">Google Cloud Trace</a> as shown
below.</p>
<p><img src="assets/images/trace_gke.png" alt="A screenshot of a Google Cloud Trace page"></p>
<h2>Multi-Region</h2>
<p><code>weaver gke</code> allows you to deploy a Service Weaver application to multiple
<a href="https://cloud.google.com/compute/docs/regions-zones">cloud regions</a>. Simply
include the regions where you want to deploy in your config file. For example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[<span style="color:#fff">gke</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">regions</span> = [<span style="color:#e6db74">&#34;us-west1&#34;</span>, <span style="color:#e6db74">&#34;us-east1&#34;</span>, <span style="color:#e6db74">&#34;asia-east2&#34;</span>, <span style="color:#e6db74">&#34;europe-north1&#34;</span>]
</span></span></code></pre><p>When <code>weaver gke</code> deploys an application to multiple regions, it intentionally
does not deploy the application to every region right away. Instead, it performs
a <strong>slow rollout</strong> of the application. <code>weaver gke</code> first deploys the application
to a small subset of the regions, which act as <a href="https://sre.google/workbook/canarying-releases/">canaries</a>. The
application runs in the canary clusters for some time before being rolled out to
a larger subset of regions. <code>weaver gke</code> continues this incremental
rollout---iteratively increasing the number of regions where the application is
deployed---until the application has been rolled out to every region specified
in the config file. Within each region, <code>weaver gke</code> also slowly shifts traffic
from old application versions to new versions. We discuss this in
<a href="#versioning">the next section</a>.</p>
<p>By slowly rolling out an application across regions, <code>weaver gke</code> allows you to
catch buggy releases early and mitigate the amount of damage they can cause. The
<code>rollout</code> field in a <a href="#config-files">config file</a> determines the length of a
slow rollout. For example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[<span style="color:#fff">serviceweaver</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">rollout</span> = <span style="color:#e6db74">&#34;1h&#34;</span> <span style="color:#75715e"># Perform a one hour slow rollout.</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre><div hidden class="todo">
TODO(mwhittaker): Remove this part?
</div>
<p>You can monitor the rollout of an application using <code>weaver gke status</code>. For
example, here is the rollout schedule produced by <code>weaver gke status</code> for a one
hour deployment of the <code>hello</code> app across the us-central1, us-west1, us-south1,
and us-east1 regions.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[ROLLOUT OF hello]
</span></span><span style="display:flex;"><span>                 us-west1  us-central1  us-south1  us-east1
</span></span><span style="display:flex;"><span>TIME             a838cf1d  a838cf1d     a838cf1d   a838cf1d
</span></span><span style="display:flex;"><span>Nov  8 22:47:30  1.00      0.00         0.00       0.00
</span></span><span style="display:flex;"><span>        +15m00s  0.50      0.50         0.00       0.00
</span></span><span style="display:flex;"><span>        +30m00s  0.33      0.33         0.33       0.00
</span></span><span style="display:flex;"><span>        +45m00s  0.25      0.25         0.25       0.25
</span></span></code></pre><p>Every row in the schedule shows the fraction of traffic each region receives
from the global load balancer. The top row is the current traffic assignment,
and each subsequent row shows the projected traffic assignment at some point in
the future. Noting that only regions with a deployed application receive
traffic, we can see the application is initially deployed in us-west1, then
slowly rolls out to us-central1, us-south1, and us-east1 in 15 minute
increments.</p>
<p>Also note that while the global load balancer balances traffic across regions,
once a request is received within a region, it is processed entirely within that
region. As with slow rollouts and canarying, avoiding cross-region communication
is a form of <a href="https://sre.google/workbook/canarying-releases/#dependencies-and-isolation">isolation</a> that helps minimize the blast radius of a
misbehaving application.</p>
<h2>Versioning</h2>
<p>To roll out a new version of your application as a replacement of an existing
version, simply rebuild your application and run <code>weaver gke deploy</code> again.
<code>weaver gke</code> will slowly roll out the new version of the application to the
regions provided in the config file, as described in the previous section. In
addition to slowly rolling out <em>across</em> regions, <code>weaver gke</code> also slowly rolls
out <em>within</em> regions. Within each region, <code>weaver gke</code> updates the global load
balancer to slowly shift traffic from the old version of the application to the
new version.</p>
<div hidden class="todo">
TODO(mwhittaker): Remove this part?
</div>
<p>We can again use <code>weaver gke status</code> to monitor the rollout of a new application
version. For example, here is the rollout schedule produced by <code>weaver gke status</code> for a one hour update of the <code>hello</code> app across the us-west1 and
us-east1 regions. The new version of the app <code>45a521a3</code> is replacing the old
version <code>def1f485</code>.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[ROLLOUT OF hello]
</span></span><span style="display:flex;"><span>                 us-west1  us-west1  us-east1  us-east1
</span></span><span style="display:flex;"><span>TIME             def1f485  45a521a3  def1f485  45a521a3
</span></span><span style="display:flex;"><span>Nov  9 00:54:59  0.45      0.05      0.50      0.00
</span></span><span style="display:flex;"><span>         +4m46s  0.38      0.12      0.50      0.00
</span></span><span style="display:flex;"><span>         +9m34s  0.25      0.25      0.50      0.00
</span></span><span style="display:flex;"><span>        +14m22s  0.12      0.38      0.50      0.00
</span></span><span style="display:flex;"><span>        +19m10s  0.00      0.50      0.50      0.00
</span></span><span style="display:flex;"><span>        +29m58s  0.00      0.50      0.45      0.05
</span></span><span style="display:flex;"><span>        +34m46s  0.00      0.50      0.38      0.12
</span></span><span style="display:flex;"><span>        +39m34s  0.00      0.50      0.25      0.25
</span></span><span style="display:flex;"><span>        +44m22s  0.00      0.50      0.12      0.38
</span></span><span style="display:flex;"><span>        +49m10s  0.00      0.50      0.00      0.50
</span></span></code></pre><p>Every row in the schedule shows the fraction of traffic that every deployment
receives in every region. The schedule shows that the new application is rolled
out in us-west1 before us-east1. Initially, the new version receives
increasingly more traffic in the us-west1 region, transitioning from 5% of the
global traffic (10% of the us-west1 traffic) to 50% of the global traffic (100%
of the us-west1 traffic) over the course of roughly 20 minutes. Ten minutes
later, this process repeats in us-east1 over the course of another 20 minutes
until the new version is receiving 100% of the global traffic. After the full
one hour rollout is complete, the old version is considered obsolete and is
deleted automatically.</p>
<p><strong>Note</strong>: While the load balancer balances traffic across application versions,
once a request is received, it is processed entirely by the version that
received it. There is no cross-version communication.</p>
<p>Superficially, <code>weaver gke</code>'s rollout scheme seems to require a lot of resources
because it runs two copies of the application side-by-side. In reality,
<code>weaver gke</code>'s use of autoscaling makes this type of
<a href="https://docs.aws.amazon.com/whitepapers/latest/overview-deployment-options/bluegreen-deployments.html">blue/green rollout</a> resource efficient. As traffic is shifted away
from the old version, its load decreases, and the autoscaler reduces its
resource allocation. Simultaneously, as the new version receives more traffic,
its load increases, and the autoscaler begins to increase its resource
allocation. These two transitions cancel out causing the rollout to use a
roughly constant number of resources.</p>
<div hidden class="todo">
TODO(mwhittaker): What if the new version doesn't have the same regions as
the old version? Explain what happens in this case.
</div>
<h2>Config</h2>
<p>You can configure <code>weaver gke</code> using the <code>[gke]</code> section of a
<a href="#config-files">config file</a>.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[<span style="color:#fff">gke</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">project</span> = <span style="color:#e6db74">&#34;my-google-cloud-project&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff">account</span> = <span style="color:#e6db74">&#34;my_account@gmail.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff">regions</span> = [<span style="color:#e6db74">&#34;us-west1&#34;</span>, <span style="color:#e6db74">&#34;us-east1&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">public_listener</span> = [
</span></span><span style="display:flex;"><span>    {<span style="color:#fff">name</span> = <span style="color:#e6db74">&#34;cat&#34;</span>, <span style="color:#fff">hostname</span> = <span style="color:#e6db74">&#34;cat.com&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#fff">name</span> = <span style="color:#e6db74">&#34;hat&#34;</span>, <span style="color:#fff">hostname</span> = <span style="color:#e6db74">&#34;hat.gg&#34;</span>},
</span></span><span style="display:flex;"><span>]
</span></span></code></pre><table>
<thead>
<tr>
<th>Field</th>
<th>Required?</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>project</td>
<td>optional</td>
<td>Name of the Google Cloud Project in which to deploy the Service Weaver application. If absent, the currently active project is used (i.e. <code>gcloud config get-value project</code>)</td>
</tr>
<tr>
<td>account</td>
<td>required</td>
<td>Google Cloud account used to deploy the Service Weaver application. If absent, the currently active account is used (i.e. <code>gcloud config get-value account</code>).</td>
</tr>
<tr>
<td>regions</td>
<td>optional</td>
<td>Regions in which the Service Weaver application should be deployed. Defaults to <code>[&quot;us-west1&quot;]</code>.</td>
</tr>
<tr>
<td>public_listener</td>
<td>optional</td>
<td>The application's public listeners along with their corresponding hostnames.</td>
</tr>
</tbody>
</table>
<h1>Local GKE</h1>
<p><a href="#gke"><code>weaver gke</code></a> lets you deploy Service Weaver applications to GKE. <code>weaver gke-local</code>
is a drop-in replacement for <code>weaver gke</code> that allows you to simulate GKE
deployments locally on your machine. Every <code>weaver gke</code> command can be replaced
with an equivalent <code>weaver gke-local</code> command. <code>weaver gke deploy</code> becomes
<code>weaver gke-local deploy</code>; <code>weaver gke status</code> becomes <code>weaver gke-local status</code>;
and so on. <code>weaver gke-local</code> runs your components in simulated GKE clusters and
launches a local proxy to emulate GKE's global load balancer. <code>weaver gke-local</code>
also uses <a href="#gke-config">the same config as a <code>weaver gke</code></a>, meaning that after you
test your application locally using <code>weaver gke-local</code>, you can deploy the same
application to GKE without any code <em>or</em> config changes.</p>
<h2>Installation</h2>
<p>First, <a href="#installation">ensure you have Service Weaver installed</a>. Next, install
the <code>weaver-gke-local</code> command:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ go install github.com/ServiceWeaver/weaver-gke/cmd/weaver-gke-local@latest
</span></span></code></pre><h2>Getting Started</h2>
<p>In the <a href="#gke-getting-started"><code>weaver gke</code></a> section, we deployed a &quot;Hello,
World!&quot; application to GKE using <code>weaver gke deploy</code>. We can deploy the same app
locally using <code>weaver gke-local deploy</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ cat weaver.toml
</span></span><span style="display:flex;"><span>[serviceweaver]
</span></span><span style="display:flex;"><span>binary = &#34;./hello&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[gke]
</span></span><span style="display:flex;"><span>regions = [&#34;us-west1&#34;]
</span></span><span style="display:flex;"><span>public_listener = [
</span></span><span style="display:flex;"><span>  {name = &#34;hello&#34;, hostname = &#34;hello.com&#34;},
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>$ weaver gke-local deploy weaver.toml
</span></span><span style="display:flex;"><span>Deploying the application... Done
</span></span><span style="display:flex;"><span>Version &#34;a2bc7a7a-fcf6-45df-91fe-6e6af171885d&#34; of app &#34;hello&#34; started successfully.
</span></span><span style="display:flex;"><span>Note that stopping this binary will not affect the app in any way.
</span></span><span style="display:flex;"><span>Tailing the logs...
</span></span><span style="display:flex;"><span>...
</span></span></code></pre><p>You can run <code>weaver gke-local status</code> to check the status of all the applications
deployed using <code>weaver gke-local</code>.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver gke-local status
</span></span><span style="display:flex;"><span>╭─────────────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ Deployments                                                 │
</span></span><span style="display:flex;"><span>├───────┬──────────────────────────────────────┬─────┬────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT                           │ AGE │ STATUS │
</span></span><span style="display:flex;"><span>├───────┼──────────────────────────────────────┼─────┼────────┤
</span></span><span style="display:flex;"><span>│ hello │ af09030c-b3a6-4d15-ba47-cd9e9e9ec2e7 │ 13s │ ACTIVE │
</span></span><span style="display:flex;"><span>╰───────┴──────────────────────────────────────┴─────┴────────╯
</span></span><span style="display:flex;"><span>╭──────────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ COMPONENTS                                               │
</span></span><span style="display:flex;"><span>├───────┬────────────┬──────────┬────────────────┬─────────┤
</span></span><span style="display:flex;"><span>│ APP   │ DEPLOYMENT │ LOCATION │ COMPONENT      │ HEALTHY │
</span></span><span style="display:flex;"><span>├───────┼────────────┼──────────┼────────────────┼─────────┤
</span></span><span style="display:flex;"><span>│ hello │ af09030c   │ us-west1 │ hello.Reverser │ 2/2     │
</span></span><span style="display:flex;"><span>│ hello │ af09030c   │ us-west1 │ main           │ 2/2     │
</span></span><span style="display:flex;"><span>╰───────┴────────────┴──────────┴────────────────┴─────────╯
</span></span><span style="display:flex;"><span>╭─────────────────────────────────────────────────────────────────────────────────────────────╮
</span></span><span style="display:flex;"><span>│ TRAFFIC                                                                                     │
</span></span><span style="display:flex;"><span>├───────────┬────────────┬───────┬────────────┬──────────┬─────────────────┬──────────────────┤
</span></span><span style="display:flex;"><span>│ HOST      │ VISIBILITY │ APP   │ DEPLOYMENT │ LOCATION │ ADDRESS         │ TRAFFIC FRACTION │
</span></span><span style="display:flex;"><span>├───────────┼────────────┼───────┼────────────┼──────────┼─────────────────┼──────────────────┤
</span></span><span style="display:flex;"><span>│ hello.com │ public     │ hello │ af09030c   │ us-west1 │ 127.0.0.1:46539 │ 0.5              │
</span></span><span style="display:flex;"><span>│ hello.com │ public     │ hello │ af09030c   │ us-west1 │ 127.0.0.1:43439 │ 0.5              │
</span></span><span style="display:flex;"><span>╰───────────┴────────────┴───────┴────────────┴──────────┴─────────────────┴──────────────────╯
</span></span><span style="display:flex;"><span>╭────────────────────────────╮
</span></span><span style="display:flex;"><span>│ ROLLOUT OF hello           │
</span></span><span style="display:flex;"><span>├─────────────────┬──────────┤
</span></span><span style="display:flex;"><span>│                 │ us-west1 │
</span></span><span style="display:flex;"><span>├─────────────────┼──────────┤
</span></span><span style="display:flex;"><span>│ TIME            │ af09030c │
</span></span><span style="display:flex;"><span>│ Feb 27 20:33:10 │ 1.00     │
</span></span><span style="display:flex;"><span>╰─────────────────┴──────────╯
</span></span></code></pre><p>The output is, unsurprisingly, identical to that of <code>weaver gke status</code>. There is
information about every app, component, and listener. Note that for this
example, <code>weaver gke-local</code> is running the &quot;Hello, World!&quot; application in a fake
us-west1 &quot;region&quot;, as specified in the <code>weaver.toml</code> config file.</p>
<p><code>weaver gke-local</code> runs a proxy on port 8000 that simulates the global load
balancer used by <code>weaver gke</code>. We can curl the proxy in the same way we curled
the global load balancer. Since we configured our application to associate host
name <code>hello.com</code> with the <code>hello</code> listener, we use the following command:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ curl --header <span style="color:#e6db74">&#39;Host: hello.com&#39;</span> localhost:8000/hello?name<span style="color:#f92672">=</span>Weaver
</span></span><span style="display:flex;"><span>Hello, Weaver!
</span></span></code></pre><p>You can use the <code>weaver gke-local kill</code> command to kill your deployed
application.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ weaver gke-local kill hello
</span></span><span style="display:flex;"><span>WARNING: You are about to kill every active deployment of the &#34;hello&#34; app.
</span></span><span style="display:flex;"><span>The deployments will be killed immediately and irrevocably. Are you sure you
</span></span><span style="display:flex;"><span>want to proceed?
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>Enter (y)es to continue: y
</span></span></code></pre><div hidden class="todo">
TODO(mwhittaker): Have `weaver gke-local` print instructions on how to curl the
proxy.
</div>
<h2>Logging</h2>
<p><code>weaver gke-local deploy</code> logs to stdout. It additionally persists all log
entries in a set of files in <code>/tmp/serviceweaver/logs/weaver-gke-local</code>. Every file
contains a stream of log entries encoded as protocol buffers. You can cat,
follow, and filter these logs using <code>weaver gke-local logs</code>. For example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#75715e"># Display all of the application logs</span>
</span></span><span style="display:flex;"><span>weaver gke-local logs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Follow all of the logs (similar to tail -f).</span>
</span></span><span style="display:flex;"><span>weaver gke-local logs --follow
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs for the &#34;todo&#34; app.</span>
</span></span><span style="display:flex;"><span>weaver gke-local logs <span style="color:#e6db74">&#39;app == &#34;todo&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the debug logs for the &#34;todo&#34; app.</span>
</span></span><span style="display:flex;"><span>weaver gke-local logs <span style="color:#e6db74">&#39;app==&#34;todo&#34; &amp;&amp; level==&#34;debug&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs for the &#34;todo&#34; app in files called foo.go.</span>
</span></span><span style="display:flex;"><span>weaver gke-local logs <span style="color:#e6db74">&#39;app==&#34;todo&#34; &amp;&amp; source.contains(&#34;foo.go&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs that contain the string &#34;error&#34;.</span>
</span></span><span style="display:flex;"><span>weaver gke-local logs <span style="color:#e6db74">&#39;msg.contains(&#34;error&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs that match a regex.</span>
</span></span><span style="display:flex;"><span>weaver gke-local logs <span style="color:#e6db74">&#39;msg.matches(&#34;error: file .* already closed&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs that have an attribute &#34;foo&#34; with value &#34;bar&#34;.</span>
</span></span><span style="display:flex;"><span>weaver gke-local logs <span style="color:#e6db74">&#39;attrs[&#34;foo&#34;] == &#34;bar&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs in JSON format. This is useful if you want to</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># perform some sort of post-processing on the logs.</span>
</span></span><span style="display:flex;"><span>weaver gke-local logs --format<span style="color:#f92672">=</span>json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Display all of the logs, including internal system logs that are hidden by</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># default.</span>
</span></span><span style="display:flex;"><span>weaver gke-local logs --system
</span></span></code></pre><p>Refer to <code>weaver gke-local logs --help</code> for a full explanation of the query
language, along with many more examples.</p>
<h2>Metrics</h2>
<p>In addition to running the proxy on port 8000 (see the <a href="#local-gke-getting-started">Getting
Started</a>), <code>weaver gke-local</code> also runs a status
server on port 8001. This server's <code>/metrics</code> endpoint exports the metrics of
all running Service Weaver applications in <a href="https://prometheus.io">Prometheus format</a>,
which looks like this:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span># HELP example_count An example counter.
</span></span><span style="display:flex;"><span># TYPE example_count counter
</span></span><span style="display:flex;"><span>example_count{serviceweaver_node=&#34;bbc9beb5&#34;} 42
</span></span><span style="display:flex;"><span>example_count{serviceweaver_node=&#34;00555c38&#34;} 9001
</span></span></code></pre><p>To visualize and query the metrics, make sure Prometheus is installed on your
local machine and then add the following stanza to your Prometheus yaml config
file:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;prometheus-serviceweaver-scraper&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">5s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">targets</span>: [<span style="color:#e6db74">&#39;localhost:8001&#39;</span>]
</span></span></code></pre><h2>Profiling</h2>
<p>Use the <code>weaver gke-local profile</code> command to collect a profile of your Service Weaver
application. Invoke the command with the name (and optionally version) of the
app you wish to profile. For example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#75715e"># Collect a CPU profile of the latest version of the hello app.</span>
</span></span><span style="display:flex;"><span>$ weaver gke-local profile hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Collect a CPU profile of a specific version of the hello app.</span>
</span></span><span style="display:flex;"><span>$ weaver gke-local profile --version<span style="color:#f92672">=</span>8e1c640a-d87b-4020-b3dd-4efc1850756c hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Adjust the duration of a CPU profile.</span>
</span></span><span style="display:flex;"><span>$ weaver gke-local profile --duration<span style="color:#f92672">=</span>1m hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Collect a heap profile.</span>
</span></span><span style="display:flex;"><span>$ weaver gke-local profile --type<span style="color:#f92672">=</span>heap hello
</span></span></code></pre><p><code>weaver gke-local profile</code> prints out the filename of the collected profile. You
can use the <code>go tool pprof</code> command to visualize and analyze the profile. For
example:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>$ profile<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>weaver gke-local profile &lt;app&gt;<span style="color:#66d9ef">)</span>    <span style="color:#75715e"># Collect the profile.</span>
</span></span><span style="display:flex;"><span>$ go tool pprof -http<span style="color:#f92672">=</span>localhost:9000 $profile <span style="color:#75715e"># Visualize the profile.</span>
</span></span></code></pre><p>Refer to <code>weaver gke-local profile --help</code> for more details.</p>
<h2>Tracing</h2>
<p>Run <code>weaver gke-local dashboard</code> to open a dashboard in a web browser. The
dashboard has a page for every Service Weaver application deployed via
<code>weaver gke-local deploy</code>. Every deployment's page has a link to the
deployment's <a href="#tracing">traces</a> accessible via <a href="https://ui.perfetto.dev/">Perfetto</a>. Here's an
example of what the tracing page looks like:</p>
<p><img src="assets/images/trace_gke_local.png" alt="An example trace page"></p>
<p>Refer to <a href="https://perfetto.dev/docs/visualization/perfetto-ui">Perfetto UI Docs</a>
to learn more about how to use the tracing UI.</p>
<h2>Versioning</h2>
<p>Recall that <code>weaver gke</code> performs slow rollouts
<a href="#gke-multi-region">across regions</a> and
<a href="#versioning">across application versions</a>. <code>weaver gke-local</code> simulates this
behavior locally. When you <code>weaver gke-local deploy</code> an application, the
application is first rolled out to a number of canary regions before being
slowly rolled out to all regions. And within a region, the locally running proxy
slowly shifts traffic from old versions of the application to the new version of
the application. You can use <code>weaver gke-local status</code>, exactly like how you use
<code>weaver gke status</code>, to monitor the rollouts of your applications.</p>
<h1>Serializable Types</h1>
<p>When you invoke a component's method, the arguments to the method (and the
results returned by the method) may be serialized and sent over the network.
Thus, a component's methods may only receive and return types that Service
Weaver knows how to serialize, types we call <strong>serializable</strong>. If a component
method receives or returns a type that isn't serializable, <code>weaver generate</code>
will raise an error during code generation time. The following types are
serializable:</p>
<ul>
<li>All primitive types (e.g., <code>int</code>, <code>bool</code>, <code>string</code>) are serializable.</li>
<li>Pointer type <code>*t</code> is serializable if <code>t</code> is serializable.</li>
<li>Array type <code>[N]t</code> is serializable if <code>t</code> is serializable.</li>
<li>Slice type <code>[]t</code> is serializable if <code>t</code> is serializable.</li>
<li>Map type <code>map[k]v</code> is serializable if <code>k</code> and <code>v</code> are serializable.</li>
<li>Named type <code>t</code> in <code>type t u</code> is serializable if it is not recursive and one
or more of the following are true:
<ul>
<li><code>t</code> is a protocol buffer (i.e. <code>*t</code> implements <code>proto.Message</code>);</li>
<li><code>t</code> implements <a href="https://pkg.go.dev/encoding#BinaryMarshaler"><code>encoding.BinaryMarshaler</code></a> and
<a href="https://pkg.go.dev/encoding#BinaryUnmarshaler"><code>encoding.BinaryUnmarshaler</code></a>;</li>
<li><code>u</code> is serializable; or</li>
<li><code>u</code> is a struct type that embeds <code>weaver.AutoMarshal</code> (see below).</li>
</ul>
</li>
</ul>
<p>The following types are not serializable:</p>
<ul>
<li>Chan type <code>chan t</code> is <em>not</em> serializable.</li>
<li>Struct literal type <code>struct{...}</code> is <em>not</em> serializable.</li>
<li>Function type <code>func(...)</code> is <em>not</em> serializable.</li>
<li>Interface type <code>interface{...}</code> is <em>not</em> serializable.</li>
</ul>
<p><strong>Note</strong>: Named struct types that don't implement <code>proto.Message</code> or
<code>BinaryMarshaler</code> and <code>BinaryUnmarshaler</code> are <em>not</em> serializable by default.
However, they can trivially be made serializable by embedding
<code>weaver.AutoMarshal</code>.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#fff">Pair</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">AutoMarshal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff">x</span>, <span style="color:#fff">y</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The <code>weaver.AutoMarshal</code> embedding instructs <code>weaver generate</code> to generate
serialization methods for the struct. Note, however, that <code>weaver.AutoMarshal</code>
cannot magically make <em>any type</em> serializable. For example, <code>weaver generate</code>
will raise an error for the following code because the <code>NotSerializable</code> struct
is fundamentally not serializable.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#75715e">// ERROR: NotSerializable cannot be made serializable.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#fff">NotSerializable</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">AutoMarshal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff">f</span> <span style="color:#66d9ef">func</span>()   <span style="color:#75715e">// functions are not serializable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#fff">c</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// chans are not serializable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre><p>Also note that <code>weaver.AutoMarshal</code> can <em>not</em> be embedded in generic structs.</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#75715e">// ERROR: Cannot embed weaver.AutoMarshal in a generic struct.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#fff">Pair</span>[<span style="color:#fff">A</span> <span style="color:#fff">any</span>] <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff">weaver</span>.<span style="color:#fff">AutoMarshal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff">x</span> <span style="color:#fff">A</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff">y</span> <span style="color:#fff">A</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>To serialize generic structs, implement <code>BinaryMarshaler</code> and
<code>BinaryUnmarshaler</code>.</p>
<p>Finally note that while <a href="#components-interfaces">Service Weaver requires every component method to
return an <code>error</code></a>, <code>error</code> is not a
serializable type. Service Weaver serializes <code>error</code>s in a way that does not
preserve any custom <code>Is</code> or <code>As</code> methods.</p>
<h1>weaver generate</h1>
<p><code>weaver generate</code> is Service Weaver's code generator. Before you compile and run a Service Weaver
application, you should run <code>weaver generate</code> to generate the code Service Weaver needs
to run an application. For example, <code>weaver generate</code> generates code to marshal
and unmarshal any types that may be sent over the network.</p>
<p>From the command line, <code>weaver generate</code> accepts a list of package paths. For
example, <code>weaver generate . ./foo</code> will generate code for the Service Weaver applications
in the current directory and in the <code>./foo</code> directory. For every package, the
generated code is placed in a <code>weaver_gen.go</code> file in the package's directory.
Running <code>weaver generate .  ./foo</code>, for example, will create <code>./weaver_gen.go</code>
and <code>./foo/weaver_gen.go</code>. You specify packages for <code>weaver generate</code> in the same
way you specify packages for <code>go build</code>, <code>go test</code>, <code>go vet</code>, etc. Run <code>go help packages</code> for more information.</p>
<p>While you can invoke <code>weaver generate</code> directly, we recommend that you instead
place a line of the following form in one of the <code>.go</code> files in the root of
your module:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#75715e">//go:generate weaver generate ./...
</span></span></span></code></pre><p>Then, you can use the <a href="https://pkg.go.dev/cmd/go/internal/generate"><code>go generate</code></a> command to generate all of
the <code>weaver_gen.go</code> files in your module.</p>
<h1>Config Files</h1>
<p>Service Weaver config files are written in <a href="https://toml.io/en/">TOML</a> and look something
like this:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>[<span style="color:#fff">serviceweaver</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">name</span> = <span style="color:#e6db74">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff">binary</span> = <span style="color:#e6db74">&#34;./hello&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff">args</span> = [<span style="color:#e6db74">&#34;these&#34;</span>, <span style="color:#e6db74">&#34;are&#34;</span>, <span style="color:#e6db74">&#34;command&#34;</span>, <span style="color:#e6db74">&#34;line&#34;</span>, <span style="color:#e6db74">&#34;arguments&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">env</span> = [<span style="color:#e6db74">&#34;PUT=your&#34;</span>, <span style="color:#e6db74">&#34;ENV=vars&#34;</span>, <span style="color:#e6db74">&#34;HERE=&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">colocate</span> = [
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;main/Rock&#34;</span>, <span style="color:#e6db74">&#34;main/Paper&#34;</span>, <span style="color:#e6db74">&#34;main/Scissors&#34;</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;github.com/example/sandy/PeanutButter&#34;</span>, <span style="color:#e6db74">&#34;github.com/example/sandy/Jelly&#34;</span>],
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span><span style="color:#fff">rollout</span> = <span style="color:#e6db74">&#34;1m&#34;</span>
</span></span></code></pre><p>A config file includes a <code>[serviceweaver]</code> section followed by a subset of the following
fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Required?</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>optional</td>
<td>Name of the Service Weaver application. If absent, the name of the app is derived from the name of the binary.</td>
</tr>
<tr>
<td>binary</td>
<td>required</td>
<td>Compiled Service Weaver application. The binary path, if not absolute, should be relative to the directory that contains the config file.</td>
</tr>
<tr>
<td>args</td>
<td>optional</td>
<td>Command line arguments passed to the binary.</td>
</tr>
<tr>
<td>env</td>
<td>optional</td>
<td>Environment variables that are set before the binary executes.</td>
</tr>
<tr>
<td>colocate</td>
<td>optional</td>
<td>List of colocation groups. When two components in the same colocation group are deployed, they are deployed in the same OS process, where all method calls between them are performed as regular Go method calls. To avoid ambiguity, components must be prefixed by their full package path (e.g., <code>github.com/example/sandy/</code>). Note that the full package path of the main package in an executable is <code>main</code>.</td>
</tr>
<tr>
<td>rollout</td>
<td>optional</td>
<td>How long it will take to roll out a new version of the application. See the <a href="#gke-multi-region">GKE Deployments</a> section for more information on rollouts.</td>
</tr>
</tbody>
</table>
<p>A config file may also contain component-specific configuration. See the
<a href="#components-config">Component Config</a> section for details.</p>
<div hidden class="todo">
Architecture
TODO: Explain the internals of Service Weaver.
</div>
<h1>FAQ</h1>
<h3>What types of distributed applications does Service Weaver target?</h3>
<p>Service Weaver primarily targets distributed serving systems. These are online
systems that need to handle user requests as they arrive. A web application or
an API server are serving systems, for example. Service Weaver tailors its
feature set and runtime assumptions towards serving systems in the following
ways:</p>
<ul>
<li><em>Network servers are integrated into the framework</em>. The application can
easily obtain a network listener and create an HTTP server on top of it.</li>
<li><em>Rollouts are built into the framework</em>. The user specifies the rollout
duration and the framework gradually shifts network traffic from the old
version to the new.</li>
<li><em>All components are replicated</em>. A request for a component can go to any one
of its replicas. Replicas may automatically be scaled up and down depending on
the load.</li>
</ul>
<h3>What about data-processing applications? Can I use Service Weaver for those?</h3>
<p>In theory, you may be able to use Service Weaver for data-processing
applications, though you will find that it provides little support for some of
the common data-processing features such as checkpointing, failure recovery,
restarts etc.</p>
<p>Additionally, Service Weaver's replication model means that component replicas
may automatically be scaled up and down depending on the load. This is likely
something that you wouldn't want in your data-processing application. This
scale-up/scale-down behavior translates even to the application's <code>main()</code>
function and may cause your data-processing program to run multiple times.</p>
<h3>Why doesn't Service Weaver provide its own data storage?</h3>
<p>Different applications have different storage needs (e.g., global replication,
performance, SQL/NoSQL). There are also a <a href="https://db-engines.com/en/ranking">myriad</a> of storage
systems out there that make different tradeoffs along various dimensions
(e.g., price, performance, API).</p>
<p>We didn't feel like we could provide enough value by inserting ourselves
into the application's data model. We also didn't want to restrict how
applications interact with their data (e.g., offline DB updates). For those
reasons, we left the choice of data storage up to the application.</p>
<h3>Doesn't the lack of data storage integration limit the portability of Service Weaver applications?</h3>
<p>Yes, to a degree. If you use a globally reachable data storage system, then you
can truly run your application anywhere, removing any portability concerns.</p>
<p>If, however, you run your storage system inside your deployment environment
(e.g., a MySQL instance running in the Cloud VPN), then if you start your
application in a different environment (e.g., your desktop), it may not have
access to the storage system. In such cases, we generally recommend that you
create different storage systems for different application environments, and
use Service Weaver <a href="#config-files">config files</a> to point your application to
the right storage system for the given execution environment.</p>
<p>If you're using SQL, Go's <a href="https://pkg.go.dev/database/sql">sql package</a> helps isolate your
code from some differences in the underlying storage systems. See the
Service Weaver's <a href="https://github.com/ServiceWeaver/weaver/tree/main/examples/chat/">chat application example</a> for how to setup
your application to use the environment-local storage systems.</p>
<h3>Does the Service Weaver versioning approach mean I will end up running multiple instances of my app during a rollout? Isn't that expensive?</h3>
<p>As we described in the GKE <a href="#versioning">versioning</a> section, we utilize the
combination of auto-scaling and blue/green deployment to minimize the cost
of running multiple versions of the same application during rollouts.</p>
<p>In general, it is up to the deployer implementation to ensure that the
rollout cost is minimized. We envision that most cloud deployers will use a
similar technique to GKE to minimize their rollout costs. Other deployers
may choose to simply run full per-version serving trees, like the
<a href="#multiprocess">multiprocess</a> deployer.</p>
<h3>Service Weaver's microservice development model is quite unique. Is it making a stand against traditional microservices development?</h3>
<p>No. We acknowledge that there are still valid reasons why developers may
choose to run separate binaries for different microservices (e.g.,
different teams controlling their own binaries). We believe, however,
that Service Weaver's <em>modular monolith</em> model is applicable to a lot of
common use-cases and can be used in conjunction with the traditional
microservices model.</p>
<p>For example, a team may decide to unify all of the services in their control
into a single Service Weaver application. Cross-team interactions will still
be handled in the traditional model, with all of the versioning and development
implications that come with that model.</p>
<h3>Isn't writing &quot;monoliths&quot; a step in the wrong direction for distributed application development?</h3>
<p>Service Weaver is trying to encourage a <em>modular monolith</em> model, where
the application is written as a single modularized binary that runs as separate
microservices. This is different from the monolith model, where the binary runs
as a single (replicated) service.</p>
<p>We believe that the Service Weaver's <em>modular monolith</em> model has the best of
both worlds: the ease of development of monolithic applications, with the
runtime benefits of microservices.</p>

        </div>
      </div>
    </div>
  </body>
  <script src="/assets/js/toc.js"></script>
  <script src="/assets/js/copy.js"></script>
</html>
